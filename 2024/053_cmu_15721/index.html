<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Bill Hu"><meta name="keywords" content=""><meta name="description" content="CMU Advanced Database, Fall 2024"><meta property="og:type" content="article"><meta property="og:title" content="[Lecture Notes] CMU 15-721 Advanced Database"><meta property="og:url" content="https://www.billhu.us/2024/053_cmu_15721/index.html"><meta property="og:site_name" content="Bill Hu&#39;s Blog"><meta property="og:description" content="CMU Advanced Database, Fall 2024"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.billhu.us/2024/053_cmu_15721/sql-process-4stages.webp"><meta property="og:image" content="https://www.billhu.us/2024/053_cmu_15721/partition-phas.webp"><meta property="og:image" content="https://www.billhu.us/2024/053_cmu_15721/probe-phase.webp"><meta property="og:image" content="https://www.billhu.us/2024/053_cmu_15721/impediments-to-speedup.webp"><meta property="og:image" content="https://www.billhu.us/2024/053_cmu_15721/lock-compatibility.webp"><meta property="og:image" content="https://www.billhu.us/2024/053_cmu_15721/isolation-level.webp"><meta property="og:image" content="https://www.billhu.us/2024/053_cmu_15721/lock-grow-shrink-counterexample.webp"><meta property="article:published_time" content="2024-09-03T13:17:06.000Z"><meta property="article:modified_time" content="2025-07-30T01:35:52.664Z"><meta property="article:author" content="Bill Hu"><meta property="article:tag" content="Lecture Notes"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.billhu.us/2024/053_cmu_15721/sql-process-4stages.webp"><title>[Lecture Notes] CMU 15-721 Advanced Database - Bill Hu&#39;s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.15.6/katex.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/myfont.css"><link rel="stylesheet" href="/css/jetbrains-mono.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"www.billhu.us",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:25,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},gtag:null},search_path:"/local-search.xml",include_content_in_search:!0});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script>!function(t,e,n,c,a,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/fjnxcr4gva",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,r)}(window,document,"clarity","script")</script><meta name="google-site-verification" content="IqNfw3GiMxuhw7kYoEdhMJoh3j99KHuGI9bw00hPn2c"><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet"><meta name="generator" content="Hexo 7.1.1"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Bill Hu&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="https://www.billhu.xyz" target="_self"><i class="iconfont icon-code"></i> <span>Portfolio</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="[Lecture Notes] CMU 15-721 Advanced Database"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-09-03 13:17" pubdate>September 3, 2024 pm</time></span></div><div class="mt-1"></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">[Lecture Notes] CMU 15-721 Advanced Database</h1><div class="markdown-body"><h1 id="lec-2-system-r-optimizer"><a class="markdownIt-Anchor" href="#lec-2-system-r-optimizer"></a> Lec 2. System R optimizer</h1><p>论文 A Relational Model of Data for Large Shared Data Banks</p><ul><li><p>key idea: <strong>Data Independence (DI)</strong> isolate user/application from low-level data representation.</p><p>将用户看到的applications与底层数据存储结构隔离开</p><ul><li><strong>Physical DI</strong>: insulate against changes in internal structure, e.g. sorted file, index (比如说，switching from a sorted file to an indexed file, 用户看到的应用层不会改变)</li><li><strong>Logical DI</strong>: insulate from changes in the schema (by using views)</li></ul></li></ul><p><strong>Multi-relation Query Planning</strong></p><ul><li>Choice 1 / <strong>System R approach</strong>: <strong>Bottom-up optimization</strong><ul><li>从nothing开始，逐步添加subquery构建更大的plan</li></ul></li><li>Choice 2 / <strong>Volcano / Cascades style</strong>: <strong>Top-down optimization</strong><ul><li>从整体查询开始，逐步分解为小的subquery</li></ul></li></ul><p><strong>Stages of processing SQL statement</strong></p><img src="/2024/053_cmu_15721/sql-process-4stages.webp" srcset="/img/loading.gif" lazyload><ul><li><p><strong>Parse</strong>: the query block includes SELECT list, FROM list, WHERE clause fields. Checks validity.</p></li><li><p><strong>Rewrite/Unnest</strong>: including: nested queries --&gt; flattened sub-queries; complex SQL queries --&gt; simpler and equivalent forms.</p></li><li><p><strong>Optimize</strong></p><ul><li><p><strong>Bottom-up</strong> approach: the optimizer evaluates all possible access paths and selects the plan with lowest total cost. <strong>System R Optmizer</strong> is this.</p></li><li><p><strong>Top-down</strong> approach: the optimizer begins with the desired outcome and then works its way down the tree to identify the optimal plan to achieve the goal.</p><p>This results in having a working plan without enumerating the entire search space, at the cost of not having a globally optimal plan.</p><p>An advantage: can timeout and still provide the best plan found so far. (In contrast, bottom-up requires processing all possible plans before delivering final result)</p></li></ul></li><li><p><strong>Execution</strong></p></li></ul><p>Different plan structures:</p><ul><li>bushy plan</li><li><strong>left deep plan</strong>: system R uses this</li><li>linear plan</li></ul><h1 id="lec-3-the-extensible-cascades-volcano-qo"><a class="markdownIt-Anchor" href="#lec-3-the-extensible-cascades-volcano-qo"></a> Lec 3. The extensible cascades / Volcano QO</h1><h1 id="lec-5-architecture-conscious-query"><a class="markdownIt-Anchor" href="#lec-5-architecture-conscious-query"></a> Lec 5. Architecture-Conscious Query</h1><div class="note note-success"><p>Paper 1: P. A. Boncz, M. Zukowski, N. Nes: MonetDB/X100: <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~15721-f24/papers/X100_Hyper_Pipelining.pdf">Hyper-Pipelining Query Execution.</a> CIDR 2005.</p><p>Paper 2: S. Schuh, X. Chen, J. Dittrich: <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~15721-f24/papers/Eval_13_Join_Algos.pdf">An Experimental Comparison of Thirteen Relational Equi-Joins in Main Memory.</a> SIGMOD 2016.</p></div><p>Traditional: Single-node systems</p><p>Nowadays: processor caches started to appear. 需要memory access pattern更优的数据库系统；multi-core systems, division to E-cores and P-cores.</p><h2 id="query-execution-processing-models"><a class="markdownIt-Anchor" href="#query-execution-processing-models"></a> Query Execution Processing Models</h2><p><strong>Iterator model</strong> (aka Volcano or Pipeline model)</p><ul><li><p>每一次query被分解为一系列的操作符operator, 这些操作符按照流水线的方式逐个进行，处理完一条记录后立即传递给下一个操作符进行处理</p></li><li><p>Each opertor consists of 3 main phases: <strong>Open, Next, Close</strong> 每一个操作符实现了open next close三个接口</p></li></ul><p>In a traditional <strong>tuple-at-a-time</strong> execution, cache inefficiency. 每次调用 Next 时，操作符只处理一条记录。</p><p><strong>Vectorization model</strong></p><p>Each operator, like in the iterator model, implements a <code>Next</code> function.</p><p>However operators emits batches of data at a time.</p><p>Vectorized execution, combined with SIMD, is becoming a standard practice.</p><h2 id="other-ways"><a class="markdownIt-Anchor" href="#other-ways"></a> Other ways</h2><p>Other ways to achieve high performance on modern processors</p><p><strong>Query Compilation</strong></p><ul><li>Transform the query to an intermediate form, then use LLVM to generate code.</li></ul><p><strong>Early vs Lata Materialization in Column Stores</strong></p><ul><li>materialize: 存储中间结果</li><li><strong>Eager</strong> materialization: projecting and materializing all required values upfront, even before they are consumed by an operator later in the query plan.</li><li><strong>Lazy</strong> materialization: instead of immediately producing the full set of values, it passes only position identifiers or record IDs until the consuming operator specifically requires the data. Reduce IO traffic and mem usage.</li><li><strong>Hybrid</strong></li></ul><h1 id="lec-5-architecture-conscious-join"><a class="markdownIt-Anchor" href="#lec-5-architecture-conscious-join"></a> Lec 5. Architecture-Conscious Join</h1><p><strong>Equi join</strong>: one of the most important operators for db.</p><p>Two common varieties</p><ul><li><strong>Sort-Merge Join (SMJ)</strong></li><li><strong>Hash Join (HJ)</strong></li></ul><h2 id="partitioned-hash-join"><a class="markdownIt-Anchor" href="#partitioned-hash-join"></a> Partitioned Hash Join</h2><p>Partitioned Hash Join consists of two phases: <strong>partition phase</strong> and <strong>probe phase</strong></p><ul><li>Partition phase<ul><li>将两个table按照相同hash function各自进行hash。如果bucket内存不够放，放到disk。</li><li><img src="/2024/053_cmu_15721/partition-phas.webp" srcset="/img/loading.gif" lazyload></li></ul></li><li>Probe phase<ul><li>将两个表的对应bucket逐一进行hash join。（此处hash join的体积较小）。</li><li><img src="/2024/053_cmu_15721/probe-phase.webp" srcset="/img/loading.gif" lazyload></li></ul></li></ul><p>Partitioned Hash Join 处理大数据集时有用；每个分区可以并行处理。</p><p><strong>Multi-Core CPU Hash Join</strong></p><ul><li>We can create hash table partitions such that the smallest partition fits into cache.</li></ul><hr><p>Equi join的例子</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> e.name, e.salary, d.department_name<br><span class="hljs-keyword">FROM</span> employees e<br><span class="hljs-keyword">JOIN</span> departments d<br><span class="hljs-keyword">ON</span> e.department_id <span class="hljs-operator">=</span> d.department_id;<br></code></pre></td></tr></table></figure><p>equi join 非常常见因为数据库大多数表通过键值等值相互关联</p><p>sort-merge join: 通过对连接列进行排序，扫描排序后的两个表，合并相同键值</p><div class="fold"><div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-28ab9646" role="button" aria-expanded="false" aria-controls="collapse-28ab9646"><div class="fold-arrow">▶</div>pseudocode</div><div class="fold-collapse collapse" id="collapse-28ab9646"><div class="fold-content"><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">FUNCTION</span> sort_merge_join(employees, departments)<br>    // Step <span class="hljs-number">1</span>: Sort <span class="hljs-keyword">both</span> <span class="hljs-keyword">tables</span> <span class="hljs-keyword">on</span> the department_id<br>    SORT employees <span class="hljs-keyword">ON</span> department_id<br>    SORT departments <span class="hljs-keyword">ON</span> department_id<br><br>    // Step <span class="hljs-number">2</span>: Initialize pointers <span class="hljs-keyword">for</span> <span class="hljs-keyword">both</span> <span class="hljs-keyword">tables</span><br>    e_pointer = <span class="hljs-number">0</span><br>    d_pointer = <span class="hljs-number">0</span><br><br>    // Step <span class="hljs-number">3</span>: Iterate <span class="hljs-keyword">over</span> <span class="hljs-keyword">both</span> <span class="hljs-keyword">tables</span> <span class="hljs-keyword">in</span> a merge <span class="hljs-keyword">loop</span><br>    <span class="hljs-keyword">WHILE</span> e_pointer &lt; employees.size <span class="hljs-keyword">AND</span> d_pointer &lt; departments.size<br>        employee = employees[e_pointer]<br>        department = departments[d_pointer]<br><br>        // Step <span class="hljs-number">4</span>: Compare department_id <span class="hljs-keyword">from</span> <span class="hljs-keyword">both</span> <span class="hljs-keyword">tables</span><br>        <span class="hljs-keyword">IF</span> employee.department_id == department.department_id <span class="hljs-keyword">THEN</span><br>            // Match <span class="hljs-built_in">found</span>, output the result<br>            OUTPUT (employee.name, employee.salary, department.department_name)<br>            // <span class="hljs-keyword">Move</span> <span class="hljs-keyword">both</span> pointers forward since a match was <span class="hljs-built_in">found</span><br>            e_pointer += <span class="hljs-number">1</span><br>            d_pointer += <span class="hljs-number">1</span><br>        <br>        <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">IF</span> employee.department_id &lt; department.department_id <span class="hljs-keyword">THEN</span><br>            // Employee department_id <span class="hljs-keyword">is</span> smaller, <span class="hljs-keyword">move</span> employee pointer<br>            e_pointer += <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">ELSE</span><br>            // Department department_id <span class="hljs-keyword">is</span> smaller, <span class="hljs-keyword">move</span> department pointer<br>            d_pointer += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">END</span> <span class="hljs-keyword">WHILE</span><br><span class="hljs-keyword">END</span> <span class="hljs-keyword">FUNCTION</span><br></code></pre></td></tr></table></figure></div></div></div><p>hash join: 在内存中将一个较小的表的连接列构建为哈希表，然后遍历扫描另一个较大的表，通过查找哈希表中的匹配值来完成连接。</p><div class="fold"><div class="fold-title fold-info collapsed" data-toggle="collapse" href="#collapse-e064c6af" role="button" aria-expanded="false" aria-controls="collapse-e064c6af"><div class="fold-arrow">▶</div>pseudocode</div><div class="fold-collapse collapse" id="collapse-e064c6af"><div class="fold-content"><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">FUNCTION</span> hash_join(employees, departments)<br>    // Step <span class="hljs-number">1</span>: Build a hash <span class="hljs-keyword">table</span> <span class="hljs-keyword">from</span> the smaller <span class="hljs-keyword">table</span>, here assume departments <span class="hljs-keyword">is</span> smaller<br>    HASH_TABLE = <span class="hljs-built_in">new</span> HashTable()<br><br>    // Step <span class="hljs-number">2</span>: <span class="hljs-keyword">Insert</span> departments <span class="hljs-keyword">into</span> hash <span class="hljs-keyword">table</span> <span class="hljs-keyword">using</span> department_id <span class="hljs-keyword">as</span> the key<br>    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> department <span class="hljs-keyword">IN</span> departments<br>        HASH_TABLE.<span class="hljs-keyword">insert</span>(department.department_id, department.department_name)<br>    <span class="hljs-keyword">END</span> <span class="hljs-keyword">FOR</span><br><br>    // Step <span class="hljs-number">3</span>: Iterate through employees <span class="hljs-keyword">and</span> probe the hash <span class="hljs-keyword">table</span> <span class="hljs-keyword">for</span> matches<br>    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> employee <span class="hljs-keyword">IN</span> employees<br>        <span class="hljs-keyword">IF</span> HASH_TABLE.contains(employee.department_id) <span class="hljs-keyword">THEN</span><br>            // Match <span class="hljs-built_in">found</span> <span class="hljs-keyword">in</span> hash <span class="hljs-keyword">table</span><br>            department_name = HASH_TABLE.<span class="hljs-keyword">get</span>(employee.department_id)<br>            // Output the matching result<br>            OUTPUT (employee.name, employee.salary, department_name)<br>        <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span><br>    <span class="hljs-keyword">END</span> <span class="hljs-keyword">FOR</span><br><span class="hljs-keyword">END</span> <span class="hljs-keyword">FUNCTION</span><br></code></pre></td></tr></table></figure></div></div></div><h1 id="lec-6-parallel-database-systems"><a class="markdownIt-Anchor" href="#lec-6-parallel-database-systems"></a> Lec 6. Parallel Database Systems</h1><div class="note note-success"><p>D. J. DeWitt, J. Gray: <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~15721-f24/papers/Parallel_Database_Systems.pdf">Parallel Database Systems: The Future of High Performance Database Systems.</a> Commun. ACM (1992).</p></div><p>Background: 1980s, single machine performance is not enough.</p><p>Two options: <strong>build database machines with specialized hardware</strong> or to <strong>run a single parallel database system over a cluster of general-purpose commodity machines</strong>. The second option is appropriate.</p><p><strong>Types of Parallel Architectures</strong></p><ul><li>Shared memory<ul><li>Pros: easy to migrate a single-node DBMS to this architecture; easily pass mem/buffers, so buffer pool management, catalog management, passing data between operators is easy.</li><li>Cons: network expensive, does not scale as new nodes added</li></ul></li><li>Shared disk<ul><li>Pros: same</li><li>Cons: network expensive (cheaper than shared memory), scalability</li></ul></li><li><strong>Shared nothing</strong><ul><li>most scalable</li><li>Cons: nearly every component of DBMS needs change.</li></ul></li></ul><h2 id="metrics-of-parallelism-speedup-and-scaleup"><a class="markdownIt-Anchor" href="#metrics-of-parallelism-speedup-and-scaleup"></a> <strong>Metrics of Parallelism</strong>: Speedup and Scaleup</h2><ul><li><strong>Speedup</strong> = Time of small system / Time of large system<ul><li><strong>Ideally: linear</strong> speedup.</li><li>For a <strong>fixed job</strong>, twice as much hardware can perform in half time.</li></ul></li><li><strong>Scaleup</strong> = Time of small job on small system / Time of large job on large system<ul><li><strong>Ideally: 1</strong>. Large system use K times as much hardware and the large job is K times as much as the small job.</li><li>Grow <strong>both the job and system</strong> sizes.</li></ul></li></ul><p>Impediments to perfect speedup</p><ul><li><img src="/2024/053_cmu_15721/impediments-to-speedup.webp" srcset="/img/loading.gif" lazyload></li><li><p><strong>Startup</strong>: non-parallelizable time needed to start a parallel operation.</p></li><li><p><strong>Interference</strong>: operation slow down each other (e.g. network contention)</p></li><li><p><strong>Skew</strong>: variance among time consumed by different operations (jobs unevenly distributed)</p></li></ul><h2 id="parallelism-in-relational-model"><a class="markdownIt-Anchor" href="#parallelism-in-relational-model"></a> Parallelism in Relational Model</h2><p>pipelined parallelism and partitioned parallelism</p><ul><li><p><strong>Pipelined Parallelism</strong></p><ul><li><p>one operator streams its output to another. The two operators can execute in parallel</p></li><li><p>However, since</p><ul><li>operation pipelines are usually short in relational queries</li><li>some operators (e.g. sorting, aggregation) need to consume all inputs before outputting anything</li><li>cost of one operator is much greater than others in the same pipeline (skew)</li></ul><p>The speedup is limited</p></li></ul></li><li><p><strong>Partitioned parallelism</strong></p><ul><li>data is distributed across the nodes. A large part of speedup/scaleup comes from this.</li><li>Different partitioning schemes 不同划分数据的方法<ul><li><strong>Range</strong>: good for sequential, associative, and clustered access with those attributes. But can lead to <strong>data skew</strong> (划分不均匀)</li><li><strong>Round Robin</strong>: evenly distribute, good for sequential scans, but bad for associative and clustered access because they require querying all nodes. 划分的最均匀，但缺少locality.</li><li><strong>Hash</strong>: good for sequential and associative access. Bad for clustered access because hash tends to randomize data rather than cluster it.</li></ul></li><li>Data Partitioning Operators<ul><li>Exchange operator (E): n个输入, m个输出, 使用特定的hash function来split input. 在m=1时，相当于merge操作.</li><li>同时也能够设置为broadcast模式</li><li>Merge operator (M)</li></ul></li></ul></li></ul><h1 id="lec-7-granularities-of-locks"><a class="markdownIt-Anchor" href="#lec-7-granularities-of-locks"></a> Lec 7. Granularities of Locks</h1><div class="note note-success"><p>Paper: J. Gray, et al.: <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~15721-f24/papers/Granularities_of_Locking.pdf">Granularity of Locks and Degrees of Consistency in a Shared Data Base.</a> IFIP Working Conference on Modelling in Data Base Management Systems 1976.</p></div><p>Granularities of Locks and Degrees of Consistency 多粒度锁</p><p><strong>ACID</strong> property: <strong>atomicity, consistency, isolation, durability</strong></p><p><strong>serializable</strong>: a schedule equivalent to some serial execution of transactions.</p><p>Two operations <strong>conflict</strong> if:</p><ul><li>they are by different transactions</li><li>they are on the same object and one of them is a write</li></ul><p>Interleaved execution <strong>anomalies</strong></p><ul><li>Read-Write conflicts (R-W) / Unrepeatable Read</li><li>Write-Read conflicts (W-R) / Dirty Read</li><li>Write-Write conflicts (W-W) / Loss Update</li></ul><h2 id="intention-locks"><a class="markdownIt-Anchor" href="#intention-locks"></a> Intention Locks</h2><p>In addition to shared (S) and exclusive (X) lock:</p><ul><li><strong>Intention-Shared (IS)</strong> locks: 表示即将对更底层的某个节点加Shared锁</li><li><strong>Intention-Exclusive (IX)</strong> locks:</li><li><strong>Shared + Intention-Exclusive (SIX)</strong> locks</li></ul><p>锁兼容性矩阵:</p><img src="/2024/053_cmu_15721/lock-compatibility.webp" srcset="/img/loading.gif" lazyload><ul><li>S与S兼容，S与X、X与S、X与X互不兼容（本来就是这样）</li><li>注意IX与IX，IX与IS是可以兼容的（因为只代表某个descendent有意向加X锁，他们意向的descendent有可能不同）</li></ul><p>加锁时：</p><ul><li>Start from the root node, in a top down manner. 首先对最上层的根节点加锁，从上往下加锁。</li><li>To get S or IS on a node, the transaction must hold at least IS on parent node.</li><li>To get X, IX or SIX on a node, must hold at least IX on parent node.</li><li>父节点被IX或IS方式加锁时，该节点可以被S或IS方式加锁</li><li>父节点被IX或SIX方式加锁时，该节点可以被X, SIX或IX方式加锁</li><li>When releasing the locks, starting bottom up. 解锁时从leaf node往root node(从下往上)解锁。</li></ul><p><strong>Lock upgrade</strong></p><ul><li>give priority to a transaction if it is already part of the granted group.</li><li>如果一个资源已经被多个transaction加锁占用，也有其它的transaction正在等待，则已经是被授予的锁的组的一部分的那个transaction会优先进行（进行锁升级操作）。</li></ul><p><strong>Deadlock 死锁</strong></p><p>死锁条件：</p><ul><li><strong>Mutual exclusion 互斥条件</strong> （某个资源一次只能被一个事务占用，例如X锁，同时只能有一个人拿到X锁）</li><li><strong>Hold and Wait 保存并等待条件</strong>（某transaction在已经占有至少一个锁的同时，正在申请并等待其它锁）</li><li><strong>No Preemption 非抢占条件</strong> （资源不能被强行剥夺，只能由资源持有者主动释放）</li><li><strong>Circular Wait 循环等待条件</strong> （存在事务相互等待的等待循环）</li></ul><p>避免死锁的方法</p><ul><li><strong>Deadlock detection</strong>: Periodically examine the wait-for-graph, pick a victim (oldest txn or newest txn), abort it to break the deadlock</li><li><strong>Deadlock prevention</strong>: Abort a txn as soon as it waits for another txn.</li><li>Wound-wait or Wait-die</li></ul><h2 id="isolation-level"><a class="markdownIt-Anchor" href="#isolation-level"></a> Isolation Level</h2><p>Want to allow various “degrees of consistency” in the same system and concurrent txns</p><p>Some txns may be ok with lower levels of consistency</p><p>四种isolation levels</p><ul><li><strong>Read Uncommitted</strong>: 最低的isolation level。A transaction can read uncommitted writes of another transaction, 即可能发生dirty read。这个模式不使用read lock，只使用write lock。</li><li><strong>Read Committed</strong>: A transaction can read the committed writes of another transaction。这个模式的S和X锁会立即释放，不遵守2PL。</li><li><strong>Repeatable Reads</strong>: In a transaction, all reads on same values will return the same value. Reads are not interfered by writes of another transaction, despite committed or not。无法避免Phantom。这个模式会使用2PL。</li><li><strong>Serializable</strong>: 最高的isolation level。能够避免Phantom。</li></ul><img src="/2024/053_cmu_15721/isolation-level.webp" srcset="/img/loading.gif" lazyload><div class="note note-info"><p>Interleaved execution <strong>anomalies</strong></p><ul><li>Read-Write conflicts (R-W) / Unrepeatable Read</li><li>Write-Read conflicts (W-R) / Dirty Read</li><li>Write-Write conflicts (W-W) / Loss Update</li></ul><p><strong>Phantom</strong> 不属于常见的三种事务并发异常（Read-Write、Write-Read、Write-Write），而是额外的一种特殊异常。Phantom Read 是一种典型的 可串行化问题（Serialization Anomaly），</p></div><hr><p>Two-phase locking (2PL)</p><ul><li><p>满足2PL一定<strong>recoverable 可恢复, serializable 可串行化</strong>, 但满足recoverable, serializable不一定需要2PL</p></li><li><p><strong>Shared mode</strong> / Read lock 读锁: 其它事务只能再对A加S锁，而不能加X锁</p></li><li><p><strong>Exclusive mode</strong> / Write lock 写锁: 其它事务不能再加任何类型的锁</p></li><li><p>Locking (Growing) Phase, Unlocking (Shrinking) Phase</p><ul><li><p>在release第一个锁之后，不能再加锁，必须要先growing phase再shrinking phase</p></li><li><p>否则会无法保证serializable，例如</p><img src="/2024/053_cmu_15721/lock-grow-shrink-counterexample.webp" srcset="/img/loading.gif" lazyload></li></ul></li><li><p><strong>strict 2PL</strong>: 在commit之后所有锁一起解锁</p><ul><li>2PL无法避免级联回滚 (cascading abort)，而strict 2PL可以避免。</li><li>**Cascading abort (级联回滚)**的意思是，某一个transaction需要回滚时，会连带导致其它transaction需要一并回滚。例如, T1对数据A进行修改，未commit，T2读取了T1修改的A，则T1由于某种原因需要回滚，T2也需要连带进行回滚。</li></ul></li></ul><h1 id="todo-lec-8-occ-optimistic-concurrency-control"><a class="markdownIt-Anchor" href="#todo-lec-8-occ-optimistic-concurrency-control"></a> (todo) Lec 8. OCC-Optimistic Concurrency Control</h1><div class="note note-success"><p>H. T. Kung, J. T. Robinson: <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~15721-f24/papers/OCC.pdf">On Optimistic Methods for Concurrency Control.</a> VLDB 1979.</p></div><h1 id="todo-lec-9-hekaton"><a class="markdownIt-Anchor" href="#todo-lec-9-hekaton"></a> (todo) Lec 9. Hekaton</h1><div class="note note-success"><p>C. Diaconu, et al.: <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~15721-f24/papers/Hekaton_SQL_Server.pdf">Hekaton: SQL server’s memory-optimized OLTP engine.</a> SIGMOD 2013.</p></div><h1 id="todo-lec-10-generalized-isolation-level"><a class="markdownIt-Anchor" href="#todo-lec-10-generalized-isolation-level"></a> (todo) Lec 10. Generalized Isolation Level</h1><div class="note note-success"><p>A. Adya, B. Liskov, P. E. O’Neil: <a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~15721-f24/papers/Generalized_Isolation_Levels_Definitions.pdf">Generalized Isolation Level Definitions.</a> ICDE 2000.</p></div></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Lecture-Notes/" class="category-chain-item">Lecture Notes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Lecture-Notes/" class="print-no-link">#Lecture Notes</a></div></div><div class="license-box my-3"><div class="license-title"><div>[Lecture Notes] CMU 15-721 Advanced Database</div><div>https://www.billhu.us/2024/053_cmu_15721/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>Bill Hu</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>September 3, 2024</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/051-cmu-15513/" title="[Lecture Notes] CMU 15-513 Intro to Computer Systems"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">[Lecture Notes] CMU 15-513 Intro to Computer Systems</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2024/50_penndot_knowledge/" title="宾州科目一 PennDot Knowledge Test"><span class="hidden-mobile">宾州科目一 PennDot Knowledge Test</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span>With </span><a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <a href="/about" target="_blank" rel="nofollow noopener"><span>Bill Hu</span></a><div style="font-size:.85rem"><span id="timeDate">Loading days...</span> <span id="times">Loading time...</span><script src="/js/duration.min.js"></script></div></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,t=t.getElementById("subtitle");t&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>