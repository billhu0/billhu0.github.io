<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Bill Hu"><meta name="keywords" content=""><meta name="description" content="CMU 14-513&#x2F;15-213&#x2F;15-513&#x2F;18-513 Intro to Computer Systems, Fall 2024"><meta property="og:type" content="article"><meta property="og:title" content="[Lecture Notes] CMU 15-513 Intro to Computer Systems"><meta property="og:url" content="https://www.billhu.us/2024/051-cmu-15513/index.html"><meta property="og:site_name" content="Bill Hu&#39;s Blog"><meta property="og:description" content="CMU 14-513&#x2F;15-213&#x2F;15-513&#x2F;18-513 Intro to Computer Systems, Fall 2024"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2024-09-03T13:17:06.000Z"><meta property="article:modified_time" content="2024-09-30T02:18:53.698Z"><meta property="article:author" content="Bill Hu"><meta property="article:tag" content="C"><meta property="article:tag" content="Lecture Notes"><meta name="twitter:card" content="summary_large_image"><title>[Lecture Notes] CMU 15-513 Intro to Computer Systems - Bill Hu&#39;s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/myfont.css"><link rel="stylesheet" href="/css/jetbrains-mono.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"www.billhu.us",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:25,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},gtag:null},search_path:"/local-search.xml",include_content_in_search:!0});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script>!function(t,e,n,c,a,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/fjnxcr4gva",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,r)}(window,document,"clarity","script")</script><meta name="google-site-verification" content="IqNfw3GiMxuhw7kYoEdhMJoh3j99KHuGI9bw00hPn2c"><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet"><meta name="generator" content="Hexo 7.1.1"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Bill Hu&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="https://www.billhu.xyz" target="_self"><i class="iconfont icon-code"></i> <span>Portfolio</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="[Lecture Notes] CMU 15-513 Intro to Computer Systems"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-09-03 13:17" pubdate>September 3, 2024 pm</time></span></div><div class="mt-1"></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">[Lecture Notes] CMU 15-513 Intro to Computer Systems</h1><div class="markdown-body"><div class="note note-info"><p>Disclaimer: 记得不全，已经会的都没记，不建议用作参考。</p></div><h1 id="lec-3-machine-level-programming-i"><a class="markdownIt-Anchor" href="#lec-3-machine-level-programming-i"></a> Lec 3. Machine-Level Programming I</h1><ul><li>x86-64 integer registers<ul><li><code>%rax</code> 64-bit</li><li><code>%eax</code> 32-bit, <code>%ax</code> 16-bit, <code>%ah</code> <code>%al</code> high 8-bit and low 8-bit respectively</li><li>backwards compatibility 向下兼容❎ 历史包袱✅</li></ul></li></ul><table><thead><tr><th>Register</th><th></th><th></th><th>Origin (许多已废弃)</th></tr></thead><tbody><tr><td><code>rax</code> (eax, ax, ah, al)</td><td></td><td></td><td>Accumulate 累加器</td></tr><tr><td><code>rbx</code> <code>ebx</code></td><td></td><td></td><td>Base 基地址(例如数组首地址 和si di差不多)</td></tr><tr><td><code>rcx</code> <code>ecx</code></td><td></td><td></td><td>Counter</td></tr><tr><td><code>rdx</code> <code>edx</code></td><td></td><td></td><td>Data</td></tr><tr><td><code>rsi</code> <code>esi</code></td><td></td><td></td><td>Source Index (源变址)</td></tr><tr><td><code>rdi</code> <code>edi</code></td><td></td><td></td><td>Destination Index (目的变址)</td></tr><tr><td><code>rsp</code> <code>esp</code></td><td></td><td></td><td>Stack Pointer</td></tr><tr><td><code>rbp</code> <code>ebp</code></td><td></td><td></td><td>Base Pointer</td></tr><tr><td><code>r8</code> <code>r8d</code></td><td></td><td></td><td></td></tr><tr><td><code>r9</code>, <code>r10</code>, <code>r11</code>, …, <code>r15</code></td><td></td><td></td><td></td></tr></tbody></table><p>关于 bx/bp/si/di 寄存器：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">a[<span class="hljs-number">10</span>] --&gt; b[<span class="hljs-number">10</span>]<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>	b[i] = a[i];<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">	a -- source index      -- si register</span><br><span class="hljs-comment">	b -- destination index -- di register</span><br><span class="hljs-comment">	现在 bx bp si di差不多</span><br><span class="hljs-comment">	以前 si di用于数组中(用户), bx操作系统解决程序重定向问题使用 (程序每次加载到内存中都是不同地址 relative addressing)</span><br><span class="hljs-comment">	bx和bp段不一样, bx si di数据段, bp 堆栈段(ss, stack segment)</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><ul><li><p>Operands 操作数</p><ul><li><strong>Immediate</strong>: e.g. <code>$0x400</code>, <code>$-533</code> (1, 2 or 4 bytes)</li><li><strong>Register</strong>: e.g. <code>%rax</code>, <code>%r13</code>.<ul><li>But <code>%rsp</code> reserved for special use.</li></ul></li><li><strong>Memory</strong>: 8-byte mem at addr given by reg: e.g. <code>(%rax)</code>.</li></ul></li><li><p><code>movq</code> operand combinations</p><ul><li>✅ imm to reg: <code>movq $0x4, %rax</code></li><li>✅ imm to mem: <code>movq $-147, (%rax)</code></li><li>✅ reg to reg: <code>movq %rax, %rdx</code></li><li>✅ reg to mem: <code>movq %rax, (%rdx)</code></li><li>✅ mem to reg: <code>movq (%rax), %rdx</code></li><li>❌ <strong>Cannot do mem-mem transfer</strong>!</li></ul></li><li><p>Complete mem addressing modes</p><ul><li><p><strong>D(Rb, Ri, S) = MEM[Reg[Rb] + S*Reg[Ri] + D]</strong> (类似二维数组)</p><ul><li><p>D: constant 1, 2, or 4 bytes</p></li><li><p>Rb: base register</p></li><li><p>Ri: index register (except <code>%rsp</code>)</p></li><li><p>S: scale 1, 2, 4, or 8</p></li><li><pre class="highlight"><code>二维数组array[10][20]
访问 a[2][3] = a[2*20+3]
a=Reg[Rb]基地址, 2=Reg[Ri](下标i), 20=S (数组是int还是short等)

二维数组  基址变址寻址 (基址rb bx bp, 变址si di)
一维数组  
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-code">    </span><br><span class="hljs-code">  - Special case: </span><br><span class="hljs-code">    - **(Rb, Ri) = MEM[Reg[Rb] + Reg[Ri]]**</span><br><span class="hljs-code">    - **D(Rb, Ri) = MEM[Reg[Rb] + Reg[Ri] + D]**</span><br><span class="hljs-code">    - **(Rb, Ri, S) = MEM[Reg[Rb] + S*Reg[Ri]]**</span><br><span class="hljs-code"></span><br><span class="hljs-bullet">-</span> Some arithmetic operations<br><span class="hljs-bullet">  -</span> <span class="hljs-code">`add`</span>, <span class="hljs-code">`sub`</span>, <span class="hljs-code">`imul`</span> (<span class="hljs-code">`imul`</span> 带符号乘法; <span class="hljs-code">`mul`</span> 无符号乘法)<br><span class="hljs-bullet">  -</span> <span class="hljs-code">`sal`</span> <span class="hljs-code">`shl`</span> (left shift), <span class="hljs-code">`sar`</span> (arithmetic right shift), <span class="hljs-code">`shr`</span> (logical) <br><span class="hljs-bullet">  -</span> <span class="hljs-code">`xor`</span>, <span class="hljs-code">`and`</span>, <span class="hljs-code">`or`</span><br><span class="hljs-bullet">  -</span> <span class="hljs-code">`inc`</span> (++dest), <span class="hljs-code">`dec`</span> (--dest), <span class="hljs-code">`neg`</span> (-dest), <span class="hljs-code">`not`</span> (~dest)<br><span class="hljs-bullet">  -</span> <span class="hljs-code">`lea`</span> (load effective address 把存储单元的地址给dst)<br><span class="hljs-bullet">    -</span> CPU designers&#x27; inteneded use: calculate pointer<br><span class="hljs-bullet">    -</span> Compiler often do: ordinary arithmetic<br><span class="hljs-bullet">      -</span> e.g. <span class="hljs-code">`lea (%rbx, %rbx, 2), %rax`</span> means <span class="hljs-code">`rax = rbx * 3`</span>.<br>  <br><span class="hljs-bullet">-</span> In most instructions, a memory operand access memory. <span class="hljs-strong">**LEA is exception!**</span><br><br><br><br><span class="hljs-section"># Lec 4. Machine Control</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**EFLAGS**</span> (RFLAGS in 64-bit) register<br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**CF (Carry Flag)**</span>: unsigned overflow 进位(+)或借位(-)<br><span class="hljs-bullet">    -</span> e.g. uint8<span class="hljs-emphasis">_t 255+1=0</span><br><span class="hljs-emphasis">  - <span class="hljs-strong">**ZF (Zero Flag)**</span>: zero</span><br><span class="hljs-emphasis">  - <span class="hljs-strong">**SF (Sign Flag)**</span>: negative 最高位为1 / 判断负数</span><br><span class="hljs-emphasis">  - <span class="hljs-strong">**OF (Overflow Flag)**</span>: signed overflow</span><br><span class="hljs-emphasis">    - 两个正数相加得到负数，或两个负数相加得到正数</span><br><span class="hljs-emphasis">    - 最高位w,y, `w == y &amp;&amp; w != z`</span><br><span class="hljs-emphasis">    - e.g. int8_</span>t 127+1=-128<br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**PF (Parity Flag)**</span><br><span class="hljs-bullet">  -</span> 一般算术运算会影响所有标志位<br><span class="hljs-bullet">  -</span> 一般逻辑运算会更改eflags然后把CF和OF置零（因为：逻辑运算只和本位有关）<br><span class="hljs-bullet">  -</span> 传送类指令<span class="hljs-code">`mov`</span>, <span class="hljs-code">`lea`</span> 等不影响标志位<br><br><br><br><span class="hljs-bullet">-</span> Compare<br><br><span class="hljs-bullet">  -</span> <span class="hljs-code">`cmp a, b`</span>: compute b-a, update condition codes<br><span class="hljs-bullet">    -</span> <span class="hljs-code">`sub`</span>和<span class="hljs-code">`cmp`</span>唯一的区别在于减出来的差值是否保留<br><span class="hljs-bullet">  -</span> <span class="hljs-code">`test a, b`</span>: compute b&amp;a, update SF and ZF<br><span class="hljs-bullet">    -</span> <span class="hljs-code">`test`</span>和<span class="hljs-code">`and`</span>唯一的区别在于结果是否保留<br><span class="hljs-bullet">    -</span> e.g. 测试某一个bit是否为1，可使用 test  reg, 0b000100 指令，接下来使用 jz 判断是否全零<br><span class="hljs-bullet">    -</span> e.g. test reg, reg 将自己和自己相与，可判断是否自己是零（和 cmp reg 0一致，但硬件层面逻辑运算速度很快，逻辑运算(与门)比算术运算(sub)运算快，因此选择test指令）<br><br><span class="hljs-bullet">-</span> Jump<br><br>  | 指令 和等效标记   | 判断条件 (不用记) |                      |      |<br>  | ----------------- | ----------------- | -------------------- | ---- |<br>  | <span class="hljs-code">`jmp`</span>             | true              | jump 无条件跳转      |      |<br>  | <span class="hljs-code">`je`</span> <span class="hljs-code">`jz`</span>         | ZF                | Equal / Zero         |      |<br>  | <span class="hljs-code">`jne`</span> <span class="hljs-code">`jnz`</span>       | ~ZF               | Not Equal / Not Zero |      |<br>  | <span class="hljs-code">`js`</span>              | SF                | 负数                 |      |<br>  | <span class="hljs-code">`jns`</span>             | ~SF               | 非负数               |      |<br>  | <span class="hljs-code">`jg`</span> <span class="hljs-code">`jnle`</span>       | ZF=0 and SF=OF    | &gt; (signed)           |      |<br>  | <span class="hljs-code">`jge`</span> <span class="hljs-code">`jnl`</span>       | SF=OF             | &gt;= (signed)          |      |<br>  | <span class="hljs-code">`jl`</span> <span class="hljs-code">`jnge`</span>       | SF != OF          | &lt; (signed)           |      |<br>  | <span class="hljs-code">`jle`</span> <span class="hljs-code">`jng`</span>       | ZF=1 or SF != OF  | &lt;= (signed)          |      |<br>  | <span class="hljs-code">`ja`</span> <span class="hljs-code">`jnbe`</span>       | CF=0 and ZF=0     | &gt; (unsigned)         |      |<br>  | <span class="hljs-code">`jb`</span> <span class="hljs-code">`jnae`</span> <span class="hljs-code">`jc`</span>  | CF                | &lt; (unsigned)         |      |<br>  |                   |                   |                      |      |<br>  | <span class="hljs-code">`jae`</span> <span class="hljs-code">`jnb`</span> <span class="hljs-code">`jnc`</span> | CF=0              | &gt;= (unsigned)        |      |<br>  | <span class="hljs-code">`jbe`</span> <span class="hljs-code">`jna`</span>       | CF=1 or BF=1      | &lt;= (unsigned)        |      |<br>  |                   |                   |                      |      |<br>  |                   |                   |                      |      |<br>  |                   |                   |                      |      |<br>  |                   |                   |                      |      |<br>  |                   |                   |                      |      |<br><br><span class="hljs-bullet">-</span> Set<br><br><span class="hljs-bullet">  -</span> 将condition codes赋值给寄存器低1字节? 高7字节不会修改<br><br><br><br><span class="hljs-section"># Lec 5. Machine-Level Programming - Procedures</span><br><br>x86-64 stack<br><br><span class="hljs-bullet">-</span> <span class="hljs-code">`pushq`</span> src: decrement <span class="hljs-strong">**rsp**</span> by 8<br><span class="hljs-bullet">-</span> <span class="hljs-code">`popq`</span> dest: increment <span class="hljs-strong">**rsp**</span> by 8, copy value<br><br><span class="hljs-bullet">-</span> <span class="hljs-code">`call label`</span>: push <span class="hljs-strong">**return address**</span> on stack (address of the next instruction after call), jump to label<br><span class="hljs-bullet">-</span> <span class="hljs-code">`ret`</span>: pop address from stack, jump to that address<br><br>传参<br><br><span class="hljs-bullet">-</span> 前六个参数: <span class="hljs-code">`rdi`</span>, <span class="hljs-code">`rsi`</span>, <span class="hljs-code">`rdx`</span>, <span class="hljs-code">`rcx`</span>, <span class="hljs-code">`r8`</span>, <span class="hljs-code">`r9`</span><br><span class="hljs-bullet">-</span> 更多的参数放在stack中<br><span class="hljs-bullet">-</span> 返回值: <span class="hljs-code">`rax`</span><br><br>Managing local data / 递归函数 Frame<br><br><span class="hljs-bullet">-</span> Stack allocated in <span class="hljs-strong">**Frames**</span><br><br>Register Saving Conventions<br><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**Caller**</span> Saved (Call-<span class="hljs-strong">**Clobbered**</span>)<br><span class="hljs-bullet">  -</span> rax (return value)<br><span class="hljs-bullet">  -</span> rdi, rsi, rdx, rcx, r8, r9 (arguments)<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**Callee**</span> Saved (Call-<span class="hljs-strong">**Preserved**</span>)<br><span class="hljs-bullet">  -</span> rbx, r10, r11, r12, r13, r14, r15 (temporaries)<br><span class="hljs-bullet">  -</span> rbp (maybe used as frame pointer, can mix &amp; match)<br><span class="hljs-bullet">  -</span> rsp (special: restored to original value upon exit)<br><br><br><br><span class="hljs-section"># Lec 6. Machine-Level Programming - Data</span><br><br>Arrays 略<br><br>Structures 略<br><br>Floating Point<br><br><span class="hljs-bullet">-</span> Arguments passed in <span class="hljs-code">`%xmm0`</span>, <span class="hljs-code">`%xmm1`</span>, ...<br><span class="hljs-bullet">-</span> All XMM reg are <span class="hljs-strong">**call-clobbered (caller saved)**</span><br><br><br><br><span class="hljs-section"># Lec 7. Machine Advanced</span><br><br><span class="hljs-section">### Buffer overflow</span><br><br><span class="hljs-bullet">-</span> #1 technical cause of security vulnerabilities<br><span class="hljs-bullet">  -</span> #1 overall cause is social engineering / user ignorance<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**Stack smashing**</span> attacks: overwrite return address, to jump to other code<br><span class="hljs-bullet">  -</span> code injection attacks: input string contains byte representation of executable code<br><span class="hljs-bullet">  -</span> How to avoid?<br><span class="hljs-bullet">    -</span> <span class="hljs-strong">**Avoid overflow vulnerabilities**</span>: e.g. <span class="hljs-code">`fgets(buf, 4, stdin)`</span> instead of <span class="hljs-code">`gets`</span><br><span class="hljs-bullet">    -</span> <span class="hljs-strong">**Randomized stack offsets**</span>: at the start of program, reposition stack. Makes it difficult for hacker to predict beginning of inserted code.<br><span class="hljs-bullet">    -</span> <span class="hljs-strong">**Non-executable memory**</span>: mark regions of mem as not executable. If jump into such region, immediate crash.<br><span class="hljs-bullet">    -</span> <span class="hljs-strong">**Stack canaries**</span>: 在stack的局部变量和返回地址之间插入一个特殊的标记值canary, 函数返回前检查该值是否被修改.<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**Return-oriented Programming**</span> attacks (ROP)<br><span class="hljs-bullet">  -</span> 不插入恶意代码，而是利用现有程序中的代码片段 (gadgets) 通常以<span class="hljs-code">`ret`</span>结尾<br><br><span class="hljs-section">### Union</span><br><br><br><br><br><br><span class="hljs-section"># Lec 8. Design and Debugging</span><br><br><span class="hljs-bullet">-</span> defect, error, failure (defeat, error not necessarily a failure)<br><span class="hljs-bullet">-</span> scientific debugging<br><span class="hljs-bullet">  -</span> hypothesis, prediction, experiment, observation &amp; conclusion, hypothesis, ...<br><br>Design<br><br>...<br><br>TODO<br><br><br><br><span class="hljs-section"># Lec 9. Memory Hierarchy</span><br><br><span class="hljs-bullet">-</span> The memory abstraction<br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**bus**</span> 总线<br><span class="hljs-bullet">-</span> RAM (<span class="hljs-strong">**SRAM**</span> / static RAM, <span class="hljs-strong">**DRAM**</span> / dynamic RAM)<br><span class="hljs-bullet">  -</span> DRAM: 1 transistor, 1 capacitor per bit; must refresh state periodically<br><span class="hljs-bullet">  -</span> SRAM: 6 transistors per bit; holds state indefinitely (but will still lose data on power loss)<br><span class="hljs-bullet">  -</span> SRAM is more expensive<br><span class="hljs-bullet">-</span> Memory hierarchy<br><span class="hljs-bullet">  -</span> Big idea (ideal): creates a large pool of storage that costs as much as the cheap storage near the bottom, but that serves data to programs at the rate of the fast storage near the top.<br><span class="hljs-bullet">-</span> Cache<br><span class="hljs-bullet">  -</span> locality<br><span class="hljs-bullet">  -</span> 3 type of cache misses: <span class="hljs-strong">**cold (compulsory)**</span> miss, <span class="hljs-strong">**capacity**</span> miss, <span class="hljs-strong">**conflict**</span> miss<br>  <br><span class="hljs-bullet">    -</span> cold misses: first reference to the block; misses with infinitely large cache<br><span class="hljs-bullet">    -</span> capacity miss: occurs when the set of active cache blocks is larger than the cache; additional misses from finite-sized cache with no placement restrictions<br><span class="hljs-bullet">    -</span> conflict miss: occurs when the cache is large enough but too many data all map (by the placement policy) to the same limited set of blocks<br>  <br><span class="hljs-code">    </span><br><span class="hljs-code"></span><br><span class="hljs-section"># Lec 10.</span><br><br>CPU cache memory<br><br><span class="hljs-bullet">-</span> small, fast SRAM-based memories.<br><br>General cache organization (<span class="hljs-strong">**S, E, B**</span>)<br><br><span class="hljs-bullet">-</span> Cache size = $S \times E \times B$ data bytes<br><span class="hljs-bullet">  -</span> 一条cache line: valid bit + tag + B=$2^b$ bytes per cache block<br><span class="hljs-bullet">-</span> 一条地址: t bits - tag, s bits - set index, b bits - block offset<br><span class="hljs-bullet">-</span> Direct Mapped cache: E = 1, one line per set<br><span class="hljs-bullet">-</span> <br><br>About Writes<br><br><span class="hljs-bullet">-</span> What to do on a write-hit?<br><br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**write-through**</span>: write immediately to memory<br><br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**write-back**</span>: defer write to memory until replacement of line (needs <span class="hljs-strong">**dirty bit**</span> for each cache line)<br><br><span class="hljs-bullet">-</span> What to do on a write-miss?<br><br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**write-allocate**</span>: load into cache, update line in cache (good if more writes to the location will follow)<br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**no-write-allocate**</span>: write straight to memory<br><br><span class="hljs-bullet">-</span> Typical: <br><br><span class="hljs-bullet">  -</span> write through + no write allocate<br><span class="hljs-bullet">  -</span> <span class="hljs-strong">**write-back**</span> + <span class="hljs-strong">**write-allocate**</span><br><br><span class="hljs-bullet">-</span> When write, the entire block of 2^b bytes are written back to memory.<br><br><br><br>Rearranging loops to improve <span class="hljs-strong">**spatial locality**</span> 矩阵乘法为例<br><br><span class="hljs-bullet">-</span> description:<br><br>  <span class="hljs-code">```c</span><br><span class="hljs-code">  // ijk</span><br><span class="hljs-code">  for (i=0; i&lt;n; i++) &#123;</span><br><span class="hljs-code">  	for (j=0; j&lt;n; j++) &#123;</span><br><span class="hljs-code">  		sum = 0.0;  // variable sum in register.</span><br><span class="hljs-code">  		for (k=0; k&lt;n; k++) &#123;</span><br><span class="hljs-code">  			sum += a[i][k] * b[k][j];</span><br><span class="hljs-code">  		&#125;</span><br><span class="hljs-code">  		c[i][j] = sum;</span><br><span class="hljs-code">  	&#125;</span><br><span class="hljs-code">  &#125;</span><br></code></pre></td></tr></table></figure>

</code></pre></li></ul></li></ul><p>O(N^3)</p><p>假设block size为32bytes (能够存下4个double)</p></li><li><p>look at the access pattern:</p><ul><li>Stepping through <strong>columns</strong> in one row: <code>for (i=0; i&lt;N; i++) sum += a[0][i]</code><ul><li>exploit spatial locality, miss rate = sizeof(aij)/B</li></ul></li><li>Stepping through <strong>rows</strong> in one column: <code>for (i=0; i&lt;N; i++) sum += a[i][0]</code><ul><li>no spatial locality, miss rate = 100%</li></ul></li><li>接下来看内层循环: <code>sum += a[i][k] * b[k][j];</code><ul><li>这里对于A的访问是stepping through columns, 对于B的访问是stepping through rows</li><li>Miss rate: A 25%, B 100%, C 0%</li><li>那么总miss per iteration是0.5</li><li>上面是ijk的情况，同理可得kij也是0.5，而其它 ijk, jik 为1.25, jki, kji 为2.0</li></ul></li></ul></li></ul><p>Use blocking to improve <strong>temporal locality</strong></p><ul><li><p>code</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">c = (<span class="hljs-type">double</span>*) <span class="hljs-built_in">calloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>), n*n);<br><br><span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;n; i+=B) &#123;<br>    <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>; i&lt;n; j+=B) &#123;<br>        <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>; k&lt;n; k+=B) &#123;<br>            <span class="hljs-comment">// B x B mini matrix multiplication</span><br>            <br>            <span class="hljs-keyword">for</span> (i1=i; i1&lt;i+B; i1++) &#123;<br>                <span class="hljs-keyword">for</span> (j1=j; j1&lt;j+B; j1++) &#123;<br>                    <span class="hljs-keyword">for</span> (k1=k; k1&lt;k+B; k1++) &#123;<br>                        c[i1 * n + j1] += a[i1 * n + k1] * b[k1 * n + j1]<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Lecture-Notes/" class="category-chain-item">Lecture Notes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/C/" class="print-no-link">#C</a> <a href="/tags/Lecture-Notes/" class="print-no-link">#Lecture Notes</a></div></div><div class="license-box my-3"><div class="license-title"><div>[Lecture Notes] CMU 15-513 Intro to Computer Systems</div><div>https://www.billhu.us/2024/051-cmu-15513/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>Bill Hu</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>September 3, 2024</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/052-cmu-15641/" title="[Lecture Notes] CMU 15-641 Networking and the Internet"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">[Lecture Notes] CMU 15-641 Networking and the Internet</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2024/50_penndot_knowledge/" title="宾州科目一 PennDot Knowledge Test"><span class="hidden-mobile">宾州科目一 PennDot Knowledge Test</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span>With </span><a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <a href="/about" target="_blank" rel="nofollow noopener"><span>Bill Hu</span></a><div style="font-size:.85rem"><span id="timeDate">Loading days...</span> <span id="times">Loading time...</span><script src="/js/duration.min.js"></script></div></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,t=t.getElementById("subtitle");t&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>