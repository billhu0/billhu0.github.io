<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Bill Hu"><meta name="keywords" content=""><meta name="description" content="CMU 14-513&#x2F;15-213&#x2F;15-513&#x2F;18-513 Intro to Computer Systems, Fall 2024"><meta property="og:type" content="article"><meta property="og:title" content="[Lecture Notes] CMU 15-513 Intro to Computer Systems"><meta property="og:url" content="https://www.billhu.us/2024/051-cmu-15513/index.html"><meta property="og:site_name" content="Bill Hu&#39;s Blog"><meta property="og:description" content="CMU 14-513&#x2F;15-213&#x2F;15-513&#x2F;18-513 Intro to Computer Systems, Fall 2024"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2024-09-03T13:17:06.000Z"><meta property="article:modified_time" content="2024-09-30T05:31:25.979Z"><meta property="article:author" content="Bill Hu"><meta property="article:tag" content="C"><meta property="article:tag" content="Lecture Notes"><meta name="twitter:card" content="summary_large_image"><title>[Lecture Notes] CMU 15-513 Intro to Computer Systems - Bill Hu&#39;s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/myfont.css"><link rel="stylesheet" href="/css/jetbrains-mono.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"www.billhu.us",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:25,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},gtag:null},search_path:"/local-search.xml",include_content_in_search:!0});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script>!function(t,e,n,c,a,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/fjnxcr4gva",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,r)}(window,document,"clarity","script")</script><meta name="google-site-verification" content="IqNfw3GiMxuhw7kYoEdhMJoh3j99KHuGI9bw00hPn2c"><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet"><meta name="generator" content="Hexo 7.1.1"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Bill Hu&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="https://www.billhu.xyz" target="_self"><i class="iconfont icon-code"></i> <span>Portfolio</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="[Lecture Notes] CMU 15-513 Intro to Computer Systems"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-09-03 13:17" pubdate>September 3, 2024 pm</time></span></div><div class="mt-1"></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">[Lecture Notes] CMU 15-513 Intro to Computer Systems</h1><div class="markdown-body"><div class="note note-info"><p>Disclaimer: 记得不全，已经会的都没记，不建议用作参考。</p></div><h1 id="lec-3-machine-level-programming-i"><a class="markdownIt-Anchor" href="#lec-3-machine-level-programming-i"></a> Lec 3. Machine-Level Programming I</h1><ul><li>x86-64 integer registers<ul><li><code>%rax</code> 64-bit</li><li><code>%eax</code> 32-bit, <code>%ax</code> 16-bit, <code>%ah</code> <code>%al</code> high 8-bit and low 8-bit respectively</li><li>backwards compatibility 向下兼容❎ 历史包袱✅</li></ul></li></ul><table><thead><tr><th>Register</th><th></th><th></th><th>Origin (许多已废弃)</th></tr></thead><tbody><tr><td><code>rax</code> (eax, ax, ah, al)</td><td></td><td></td><td>Accumulate 累加器</td></tr><tr><td><code>rbx</code> <code>ebx</code></td><td></td><td></td><td>Base 基地址(例如数组首地址 和si di差不多)</td></tr><tr><td><code>rcx</code> <code>ecx</code></td><td></td><td></td><td>Counter</td></tr><tr><td><code>rdx</code> <code>edx</code></td><td></td><td></td><td>Data</td></tr><tr><td><code>rsi</code> <code>esi</code></td><td></td><td></td><td>Source Index (源变址)</td></tr><tr><td><code>rdi</code> <code>edi</code></td><td></td><td></td><td>Destination Index (目的变址)</td></tr><tr><td><code>rsp</code> <code>esp</code></td><td></td><td></td><td>Stack Pointer</td></tr><tr><td><code>rbp</code> <code>ebp</code></td><td></td><td></td><td>Base Pointer</td></tr><tr><td><code>r8</code> <code>r8d</code></td><td></td><td></td><td></td></tr><tr><td><code>r9</code>, <code>r10</code>, <code>r11</code>, …, <code>r15</code></td><td></td><td></td><td></td></tr></tbody></table><p>关于 bx/bp/si/di 寄存器：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">a[<span class="hljs-number">10</span>] --&gt; b[<span class="hljs-number">10</span>]<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>	b[i] = a[i];<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">	a -- source index      -- si register</span><br><span class="hljs-comment">	b -- destination index -- di register</span><br><span class="hljs-comment">	现在 bx bp si di差不多</span><br><span class="hljs-comment">	以前 si di用于数组中(用户), bx操作系统解决程序重定向问题使用 (程序每次加载到内存中都是不同地址 relative addressing)</span><br><span class="hljs-comment">	bx和bp段不一样, bx si di数据段, bp 堆栈段(ss, stack segment)</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><ul><li><p>Operands 操作数</p><ul><li><strong>Immediate</strong>: e.g. <code>$0x400</code>, <code>$-533</code> (1, 2 or 4 bytes)</li><li><strong>Register</strong>: e.g. <code>%rax</code>, <code>%r13</code>.<ul><li>But <code>%rsp</code> reserved for special use.</li></ul></li><li><strong>Memory</strong>: 8-byte mem at addr given by reg: e.g. <code>(%rax)</code>.</li></ul></li><li><p><code>movq</code> operand combinations</p><ul><li>✅ imm to reg: <code>movq $0x4, %rax</code></li><li>✅ imm to mem: <code>movq $-147, (%rax)</code></li><li>✅ reg to reg: <code>movq %rax, %rdx</code></li><li>✅ reg to mem: <code>movq %rax, (%rdx)</code></li><li>✅ mem to reg: <code>movq (%rax), %rdx</code></li><li>❌ <strong>Cannot do mem-mem transfer</strong>!</li></ul></li><li><p>Complete mem addressing modes</p><ul><li><p><strong>D(Rb, Ri, S) = MEM[Reg[Rb] + S*Reg[Ri] + D]</strong> (类似二维数组)</p><ul><li><p>D: constant 1, 2, or 4 bytes</p></li><li><p>Rb: base register</p></li><li><p>Ri: index register (except <code>%rsp</code>)</p></li><li><p>S: scale 1, 2, 4, or 8</p></li><li><p>关于数组寻址</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">二维数组array<span class="hljs-selector-attr">[10]</span><span class="hljs-selector-attr">[20]</span><br>访问 <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2]</span><span class="hljs-selector-attr">[3]</span> = <span class="hljs-selector-tag">a</span><span class="hljs-selector-attr">[2*20+3]</span><br>a=Reg<span class="hljs-selector-attr">[Rb]</span>基地址, <span class="hljs-number">2</span>=Reg<span class="hljs-selector-attr">[Ri]</span>(下标i), <span class="hljs-number">20</span>=S (数组是int还是short等)<br><br>二维数组  基址变址寻址 (基址rb bx bp, 变址si di)<br>一维数组  <br></code></pre></td></tr></table></figure></li></ul></li><li><p>Special case:</p><ul><li><strong>(Rb, Ri) = MEM[Reg[Rb] + Reg[Ri]]</strong></li><li><strong>D(Rb, Ri) = MEM[Reg[Rb] + Reg[Ri] + D]</strong></li><li><strong>(Rb, Ri, S) = MEM[Reg[Rb] + S*Reg[Ri]]</strong></li></ul></li></ul></li><li><p>Some arithmetic operations</p><ul><li><code>add</code>, <code>sub</code>, <code>imul</code> (<code>imul</code> 带符号乘法; <code>mul</code> 无符号乘法)</li><li><code>sal</code> <code>shl</code> (left shift), <code>sar</code> (arithmetic right shift), <code>shr</code> (logical)</li><li><code>xor</code>, <code>and</code>, <code>or</code></li><li><code>inc</code> (++dest), <code>dec</code> (–dest), <code>neg</code> (-dest), <code>not</code> (~dest)</li><li><code>lea</code> (load effective address 把存储单元的地址给dst)<ul><li>CPU designers’ inteneded use: calculate pointer</li><li>Compiler often do: ordinary arithmetic<ul><li>e.g. <code>lea (%rbx, %rbx, 2), %rax</code> means <code>rax = rbx * 3</code>.</li></ul></li></ul></li></ul></li><li><p>In most instructions, a memory operand access memory. <strong>LEA is exception!</strong></p></li></ul><h1 id="lec-4-machine-control"><a class="markdownIt-Anchor" href="#lec-4-machine-control"></a> Lec 4. Machine Control</h1><ul><li><p><strong>EFLAGS</strong> (RFLAGS in 64-bit) register</p><ul><li><strong>CF (Carry Flag)</strong>: unsigned overflow 进位(+)或借位(-)<ul><li>e.g. uint8_t 255+1=0</li></ul></li><li><strong>ZF (Zero Flag)</strong>: zero</li><li><strong>SF (Sign Flag)</strong>: negative 最高位为1 / 判断负数</li><li><strong>OF (Overflow Flag)</strong>: signed overflow<ul><li>两个正数相加得到负数，或两个负数相加得到正数</li><li>最高位w,y, <code>w == y &amp;&amp; w != z</code></li><li>e.g. int8_t 127+1=-128</li></ul></li><li><strong>PF (Parity Flag)</strong></li><li>一般算术运算会影响所有标志位</li><li>一般逻辑运算会更改eflags然后把CF和OF置零（因为：逻辑运算只和本位有关）</li><li>传送类指令<code>mov</code>, <code>lea</code> 等不影响标志位</li></ul></li><li><p>Compare</p><ul><li><code>cmp a, b</code>: compute b-a, update condition codes<ul><li><code>sub</code>和<code>cmp</code>唯一的区别在于减出来的差值是否保留</li></ul></li><li><code>test a, b</code>: compute b&amp;a, update SF and ZF<ul><li><code>test</code>和<code>and</code>唯一的区别在于结果是否保留</li><li>e.g. 测试某一个bit是否为1，可使用 test reg, 0b000100 指令，接下来使用 jz 判断是否全零</li><li>e.g. test reg, reg 将自己和自己相与，可判断是否自己是零（和 cmp reg 0一致，但硬件层面逻辑运算速度很快，逻辑运算(与门)比算术运算(sub)运算快，因此选择test指令）</li></ul></li></ul></li><li><p>Jump</p><table><thead><tr><th>指令 和等效标记</th><th>判断条件 (不用记)</th><th></th><th></th></tr></thead><tbody><tr><td><code>jmp</code></td><td>true</td><td>jump 无条件跳转</td><td></td></tr><tr><td><code>je</code> <code>jz</code></td><td>ZF</td><td>Equal / Zero</td><td></td></tr><tr><td><code>jne</code> <code>jnz</code></td><td>~ZF</td><td>Not Equal / Not Zero</td><td></td></tr><tr><td><code>js</code></td><td>SF</td><td>负数</td><td></td></tr><tr><td><code>jns</code></td><td>~SF</td><td>非负数</td><td></td></tr><tr><td><code>jg</code> <code>jnle</code></td><td>ZF=0 and SF=OF</td><td>&gt; (signed)</td><td></td></tr><tr><td><code>jge</code> <code>jnl</code></td><td>SF=OF</td><td>&gt;= (signed)</td><td></td></tr><tr><td><code>jl</code> <code>jnge</code></td><td>SF != OF</td><td>&lt; (signed)</td><td></td></tr><tr><td><code>jle</code> <code>jng</code></td><td>ZF=1 or SF != OF</td><td>&lt;= (signed)</td><td></td></tr><tr><td><code>ja</code> <code>jnbe</code></td><td>CF=0 and ZF=0</td><td>&gt; (unsigned)</td><td></td></tr><tr><td><code>jb</code> <code>jnae</code> <code>jc</code></td><td>CF</td><td>&lt; (unsigned)</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td><code>jae</code> <code>jnb</code> <code>jnc</code></td><td>CF=0</td><td>&gt;= (unsigned)</td><td></td></tr><tr><td><code>jbe</code> <code>jna</code></td><td>CF=1 or BF=1</td><td>&lt;= (unsigned)</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table></li><li><p>Set</p><ul><li>将condition codes赋值给寄存器低1字节? 高7字节不会修改</li></ul></li></ul><h1 id="lec-5-machine-level-programming-procedures"><a class="markdownIt-Anchor" href="#lec-5-machine-level-programming-procedures"></a> Lec 5. Machine-Level Programming - Procedures</h1><p>x86-64 stack</p><ul><li><p><code>pushq</code> src: decrement <strong>rsp</strong> by 8</p></li><li><p><code>popq</code> dest: increment <strong>rsp</strong> by 8, copy value</p></li><li><p><code>call label</code>: push <strong>return address</strong> on stack (address of the next instruction after call), jump to label</p></li><li><p><code>ret</code>: pop address from stack, jump to that address</p></li></ul><p>传参</p><ul><li>前六个参数: <code>rdi</code>, <code>rsi</code>, <code>rdx</code>, <code>rcx</code>, <code>r8</code>, <code>r9</code></li><li>更多的参数放在stack中</li><li>返回值: <code>rax</code></li></ul><p>Managing local data / 递归函数 Frame</p><ul><li>Stack allocated in <strong>Frames</strong></li></ul><p>Register Saving Conventions</p><ul><li><strong>Caller</strong> Saved (Call-<strong>Clobbered</strong>)<ul><li>rax (return value)</li><li>rdi, rsi, rdx, rcx, r8, r9 (arguments)</li></ul></li><li><strong>Callee</strong> Saved (Call-<strong>Preserved</strong>)<ul><li>rbx, r10, r11, r12, r13, r14, r15 (temporaries)</li><li>rbp (maybe used as frame pointer, can mix &amp; match)</li><li>rsp (special: restored to original value upon exit)</li></ul></li></ul><h1 id="lec-6-machine-level-programming-data"><a class="markdownIt-Anchor" href="#lec-6-machine-level-programming-data"></a> Lec 6. Machine-Level Programming - Data</h1><p>Arrays 略</p><p>Structures 略</p><p>Floating Point</p><ul><li>Arguments passed in <code>%xmm0</code>, <code>%xmm1</code>, …</li><li>All XMM reg are <strong>call-clobbered (caller saved)</strong></li></ul><h1 id="lec-7-machine-advanced"><a class="markdownIt-Anchor" href="#lec-7-machine-advanced"></a> Lec 7. Machine Advanced</h1><h3 id="buffer-overflow"><a class="markdownIt-Anchor" href="#buffer-overflow"></a> Buffer overflow</h3><ul><li>#1 technical cause of security vulnerabilities<ul><li>#1 overall cause is social engineering / user ignorance</li></ul></li><li><strong>Stack smashing</strong> attacks: overwrite return address, to jump to other code<ul><li>code injection attacks: input string contains byte representation of executable code</li><li>How to avoid?<ul><li><strong>Avoid overflow vulnerabilities</strong>: e.g. <code>fgets(buf, 4, stdin)</code> instead of <code>gets</code></li><li><strong>Randomized stack offsets</strong>: at the start of program, reposition stack. Makes it difficult for hacker to predict beginning of inserted code.</li><li><strong>Non-executable memory</strong>: mark regions of mem as not executable. If jump into such region, immediate crash.</li><li><strong>Stack canaries</strong>: 在stack的局部变量和返回地址之间插入一个特殊的标记值canary, 函数返回前检查该值是否被修改.</li></ul></li></ul></li><li><strong>Return-oriented Programming</strong> attacks (ROP)<ul><li>不插入恶意代码，而是利用现有程序中的代码片段 (gadgets) 通常以<code>ret</code>结尾</li></ul></li></ul><h3 id="union"><a class="markdownIt-Anchor" href="#union"></a> Union</h3><h1 id="lec-8-design-and-debugging"><a class="markdownIt-Anchor" href="#lec-8-design-and-debugging"></a> Lec 8. Design and Debugging</h1><ul><li>defect, error, failure (defeat, error not necessarily a failure)</li><li>scientific debugging<ul><li>hypothesis, prediction, experiment, observation &amp; conclusion, hypothesis, …</li></ul></li></ul><p>Design</p><p>…</p><p>TODO</p><h1 id="lec-9-memory-hierarchy"><a class="markdownIt-Anchor" href="#lec-9-memory-hierarchy"></a> Lec 9. Memory Hierarchy</h1><ul><li>The memory abstraction<ul><li><strong>bus</strong> 总线</li></ul></li><li>RAM (<strong>SRAM</strong> / static RAM, <strong>DRAM</strong> / dynamic RAM)<ul><li>DRAM: 1 transistor, 1 capacitor per bit; must refresh state periodically</li><li>SRAM: 6 transistors per bit; holds state indefinitely (but will still lose data on power loss)</li><li>SRAM is more expensive</li></ul></li><li>Memory hierarchy<ul><li>Big idea (ideal): creates a large pool of storage that costs as much as the cheap storage near the bottom, but that serves data to programs at the rate of the fast storage near the top.</li></ul></li><li>Cache<ul><li><p>locality</p></li><li><p>3 type of cache misses: <strong>cold (compulsory)</strong> miss, <strong>capacity</strong> miss, <strong>conflict</strong> miss</p><ul><li>cold misses: first reference to the block; misses with infinitely large cache</li><li>capacity miss: occurs when the set of active cache blocks is larger than the cache; additional misses from finite-sized cache with no placement restrictions</li><li>conflict miss: occurs when the cache is large enough but too many data all map (by the placement policy) to the same limited set of blocks</li></ul></li></ul></li></ul><h1 id="lec-10"><a class="markdownIt-Anchor" href="#lec-10"></a> Lec 10.</h1><p>CPU cache memory</p><ul><li>small, fast SRAM-based memories.</li></ul><p>General cache organization (<strong>S, E, B</strong>)</p><ul><li>Cache size = <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>×</mo><mi>E</mi><mo>×</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">S \times E \times B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal" style="margin-right:.05764em">E</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.05017em">B</span></span></span></span> data bytes<ul><li>一条cache line: valid bit + tag + B=<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mi>b</mi></msup></mrow><annotation encoding="application/x-tex">2^b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.849108em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.849108em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span></span></span></span></span></span></span></span> bytes per cache block</li></ul></li><li>一条地址: t bits - tag, s bits - set index, b bits - block offset</li><li>Direct Mapped cache: E = 1, one line per set</li><li></li></ul><p>About Writes</p><ul><li><p>What to do on a write-hit?</p><ul><li><p><strong>write-through</strong>: write immediately to memory</p></li><li><p><strong>write-back</strong>: defer write to memory until replacement of line (needs <strong>dirty bit</strong> for each cache line)</p></li></ul></li><li><p>What to do on a write-miss?</p><ul><li><strong>write-allocate</strong>: load into cache, update line in cache (good if more writes to the location will follow)</li><li><strong>no-write-allocate</strong>: write straight to memory</li></ul></li><li><p>Typical:</p><ul><li>write through + no write allocate</li><li><strong>write-back</strong> + <strong>write-allocate</strong></li></ul></li><li><p>When write, the entire block of 2^b bytes are written back to memory.</p></li></ul><p>Rearranging loops to improve <strong>spatial locality</strong> 矩阵乘法为例</p><ul><li><p>description:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ijk</span><br><span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;n; i++) &#123;<br>	<span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>; j&lt;n; j++) &#123;<br>		sum = <span class="hljs-number">0.0</span>;  <span class="hljs-comment">// variable sum in register.</span><br>		<span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>; k&lt;n; k++) &#123;<br>			sum += a[i][k] * b[k][j];<br>		&#125;<br>		c[i][j] = sum;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>O(N^3)</p><p>假设block size为32bytes (能够存下4个double)</p></li><li><p>look at the access pattern:</p><ul><li>Stepping through <strong>columns</strong> in one row: <code>for (i=0; i&lt;N; i++) sum += a[0][i]</code><ul><li>exploit spatial locality, miss rate = sizeof(aij)/B</li></ul></li><li>Stepping through <strong>rows</strong> in one column: <code>for (i=0; i&lt;N; i++) sum += a[i][0]</code><ul><li>no spatial locality, miss rate = 100%</li></ul></li><li>接下来看内层循环: <code>sum += a[i][k] * b[k][j];</code><ul><li>这里对于A的访问是stepping through columns, 对于B的访问是stepping through rows</li><li>Miss rate: A 25%, B 100%, C 0%</li><li>那么总miss per iteration是0.5</li><li>上面是ijk的情况，同理可得kij也是0.5，而其它 ijk, jik 为1.25, jki, kji 为2.0</li></ul></li></ul></li></ul><p>Use blocking to improve <strong>temporal locality</strong></p><ul><li><p>code</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">c = (<span class="hljs-type">double</span>*) <span class="hljs-built_in">calloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>), n*n);<br><br><span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;n; i+=B) &#123;<br>    <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>; i&lt;n; j+=B) &#123;<br>        <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>; k&lt;n; k+=B) &#123;<br>            <span class="hljs-comment">// B x B mini matrix multiplication</span><br>            <br>            <span class="hljs-keyword">for</span> (i1=i; i1&lt;i+B; i1++) &#123;<br>                <span class="hljs-keyword">for</span> (j1=j; j1&lt;j+B; j1++) &#123;<br>                    <span class="hljs-keyword">for</span> (k1=k; k1&lt;k+B; k1++) &#123;<br>                        c[i1 * n + j1] += a[i1 * n + k1] * b[k1 * n + j1]<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Lecture-Notes/" class="category-chain-item">Lecture Notes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/C/" class="print-no-link">#C</a> <a href="/tags/Lecture-Notes/" class="print-no-link">#Lecture Notes</a></div></div><div class="license-box my-3"><div class="license-title"><div>[Lecture Notes] CMU 15-513 Intro to Computer Systems</div><div>https://www.billhu.us/2024/051-cmu-15513/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>Bill Hu</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>September 3, 2024</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/052-cmu-15641/" title="[Lecture Notes] CMU 15-641 Networking and the Internet"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">[Lecture Notes] CMU 15-641 Networking and the Internet</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2024/50_penndot_knowledge/" title="宾州科目一 PennDot Knowledge Test"><span class="hidden-mobile">宾州科目一 PennDot Knowledge Test</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span>With </span><a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <a href="/about" target="_blank" rel="nofollow noopener"><span>Bill Hu</span></a><div style="font-size:.85rem"><span id="timeDate">Loading days...</span> <span id="times">Loading time...</span><script src="/js/duration.min.js"></script></div></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,t=t.getElementById("subtitle");t&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>