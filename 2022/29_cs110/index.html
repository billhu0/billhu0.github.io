<!DOCTYPE html><html lang="en" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png"><link rel="icon" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Bill Hu"><meta name="keywords" content=""><meta name="description" content="CS110 Computer architecture I lecture notes, spring 2022"><meta property="og:type" content="article"><meta property="og:title" content="[Lecture Notes] ShanghaiTech CS110 Computer architecture I"><meta property="og:url" content="https://www.billhu.us/2022/29_cs110/index.html"><meta property="og:site_name" content="Bill Hu&#39;s Blog"><meta property="og:description" content="CS110 Computer architecture I lecture notes, spring 2022"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/siji.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/use-s0-as-a-frame-pointer.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/fp.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/instruction_formats_all.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/CMOS-NPchannel.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/law-of-boolean-algebra.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/flip-flop-timing-register.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/single-cycle-cpu-datapath.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/control-logic-truth-table.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/Pipelined-datapath.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/forwarding.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/forwarding-datapath.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/control-hazard-simple.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/Modern-complex-inorder-pipeline.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/amoswap.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/linear-page-table.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/TLB.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/hierarchical-page-table-walk.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/operation-of-DMA-transfer.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/Hamming-code-coverage.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/heartbleed.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/rowhammer.png"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/BillsCheatsheet1.jpg"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/BillsCheatsheet2.jpg"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/BillsCheatsheet3.jpg"><meta property="og:image" content="https://www.billhu.us/2022/29_cs110/BillsCheatsheet4.jpg"><meta property="article:published_time" content="2022-06-22T16:44:18.000Z"><meta property="article:modified_time" content="2025-01-17T22:59:22.694Z"><meta property="article:author" content="Bill Hu"><meta property="article:tag" content="C"><meta property="article:tag" content="Lecture Notes"><meta property="article:tag" content="C++"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.billhu.us/2022/29_cs110/siji.png"><title>[Lecture Notes] ShanghaiTech CS110 Computer architecture I - Bill Hu&#39;s Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.15.6/katex.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/myfont.css"><link rel="stylesheet" href="/css/jetbrains-mono.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"www.billhu.us",root:"/",version:"1.9.7",typing:{enable:!0,typeSpeed:25,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:3},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},gtag:null},search_path:"/local-search.xml",include_content_in_search:!0});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script>!function(t,e,n,c,a,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(a=e.createElement(c)).async=1,a.src="https://www.clarity.ms/tag/fjnxcr4gva",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(a,r)}(window,document,"clarity","script")</script><meta name="google-site-verification" content="IqNfw3GiMxuhw7kYoEdhMJoh3j99KHuGI9bw00hPn2c"><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic,700italic" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700" rel="stylesheet"><meta name="generator" content="Hexo 7.1.1"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Bill Hu&#39;s Blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>Home</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>Archives</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>Categories</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>Tags</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>About</span></a></li><li class="nav-item"><a class="nav-link" href="https://www.billhu.xyz" target="_self"><i class="iconfont icon-code"></i> <span>Portfolio</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="[Lecture Notes] ShanghaiTech CS110 Computer architecture I"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-06-22 16:44" pubdate>June 22, 2022 pm</time></span></div><div class="mt-1"></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">[Lecture Notes] ShanghaiTech CS110 Computer architecture I</h1><div class="markdown-body"><h1 id="lecture-1-introduction"><a class="markdownIt-Anchor" href="#lecture-1-introduction"></a> Lecture 1. Introduction</h1><h3 id="6-great-ideas-in-computer-architecture"><a class="markdownIt-Anchor" href="#6-great-ideas-in-computer-architecture"></a> 6 great ideas in computer architecture</h3><ol><li><strong>Abstraction</strong> (Layers of Representation / Interpretation)</li><li><strong>Moore’s Law</strong> (Designing through trends)</li><li><strong>Principle of Locality</strong> (Memory hierarchy)</li><li><strong>Parallelism</strong></li><li><strong>Performance Measurement &amp; Improvement</strong></li><li><strong>Dependability via Redundancy</strong></li></ol><h1 id="lecture-3-c-ii"><a class="markdownIt-Anchor" href="#lecture-3-c-ii"></a> Lecture 3. C II</h1><p><strong>stack</strong>: LIFO (last in, first out) data structure</p><p>stack includes: return address; arguments; space for local variables</p><p><code>strlen()</code> does not count the <code>\0</code> at the end. <code>sizeof</code> will do.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">func</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">char</span> a;          <span class="hljs-comment">// stack</span><br>    <span class="hljs-type">static</span> <span class="hljs-type">char</span> b;   <span class="hljs-comment">// static/global</span><br>    <span class="hljs-type">char</span> c[] = <span class="hljs-string">&quot;hi&quot;</span>; <span class="hljs-comment">// stack</span><br>    <span class="hljs-type">char</span> *d = <span class="hljs-string">&quot;hi&quot;</span>;  <span class="hljs-comment">// static</span><br>&#125;<br></code></pre></td></tr></table></figure><img src="/2022/29_cs110/siji.png" srcset="/img/loading.gif" lazyload><h1 id="lecture-4-riscv-intro"><a class="markdownIt-Anchor" href="#lecture-4-riscv-intro"></a> Lecture 4. Riscv intro</h1><h3 id="isa-instruction-set-architectures"><a class="markdownIt-Anchor" href="#isa-instruction-set-architectures"></a> ISA - Instruction Set architectures</h3><p><strong>RISC philosophy:</strong> <strong>Reduced Instruction Set Computing:</strong></p><ul><li>Keep the instruction set small and simple, making it easier to build fast hardware</li><li>Let software do complicated operations by composing simpler ones</li></ul><h3 id="mem-align"><a class="markdownIt-Anchor" href="#mem-align"></a> Mem align</h3><p>Risc-v does not require that integers be word aligned, but it is very bad if you don’t make sure they are.</p><p>Consequences of unaligned integers: slowdown (do unaligned-access in software; lack of atomicity).</p><p>So in practice, risc-v requires integers to be aligned on 4-byte boundaries</p><h1 id="lecture-5-riscv-decision"><a class="markdownIt-Anchor" href="#lecture-5-riscv-decision"></a> Lecture 5. Riscv decision</h1><h3 id="logical-instructions"><a class="markdownIt-Anchor" href="#logical-instructions"></a> Logical instructions</h3><p>No ‘not’ operation. Done by <code>xori -1</code> (xor with 0xFFFFFFFF)</p><h3 id="6-fundamental-steps-in-calling-a-function"><a class="markdownIt-Anchor" href="#6-fundamental-steps-in-calling-a-function"></a> 6 fundamental steps in calling a function</h3><ol><li>Put parameters in a place where function can access them</li><li>Transfer control to function</li><li>Acquire (local) storage resources needed for function</li><li>Perform desired task of the function</li><li>Put result value in a place where calling code can access it and restore any registers you used</li><li>Return control to point of origin, since a function can be called from several points in a program.</li></ol><h3 id="unconditional-branches"><a class="markdownIt-Anchor" href="#unconditional-branches"></a> Unconditional Branches</h3><p><code>jal</code> <strong>jump and link</strong> : <code>PC += imm</code>, goto that location. The offset is 20 bits, sign-extended and left-shifted one (not two). At the same time, <code>rd = PC+4</code>.</p><p><code>jalr</code> <strong>jump and link register</strong></p><h1 id="lecture-6-riscv-instruction-formats"><a class="markdownIt-Anchor" href="#lecture-6-riscv-instruction-formats"></a> Lecture 6. Riscv instruction formats</h1><h3 id="the-abi-conventions-mnemonic-registers"><a class="markdownIt-Anchor" href="#the-abi-conventions-mnemonic-registers"></a> The “ABI” conventions &amp; Mnemonic Registers</h3><p>The <strong>Application Binary Interface</strong> defines our ‘calling convention’ (how to call other functions?)</p><p>ABI defines a contract: When you call another function, that function promises not to overwrite certain registers.</p><p><strong>Register conventions</strong>: A set of generally accepted rules as to which registers will be unchanged after a procedure call (<code>jal</code>) and which may be changed.</p><p>Risc-v function-calling convention devides regs into two categories:</p><ul><li><p><strong>Preserved accross function call</strong> (caller can rely on values being unchanged, <strong>callee-saved</strong>)</p><p><code>sp</code>, <code>gp</code>, <code>tp</code>, <code>s0-s11</code> (<code>s0</code> is also <code>fp</code>)</p></li><li><p><strong>Not preserved across function call</strong> (<strong>caller-saved</strong> registers)</p><p><code>a0-a7</code>, <code>ra</code>, <code>t0-t6</code></p></li></ul><h3 id="allocating-space-on-stack"><a class="markdownIt-Anchor" href="#allocating-space-on-stack"></a> Allocating space on stack</h3><ul><li><p>saved return address (if needed)</p></li><li><p>saved argument registers (if any) (if more argument)</p></li><li><p>saved saved registers (if any) (s0, …)</p></li><li><p>local variables (if any)</p></li></ul><h3 id="memory-allocation"><a class="markdownIt-Anchor" href="#memory-allocation"></a> Memory allocation</h3><p>Stack starts in high memory and grows down</p><p>Stack must be aligned on 16-Byte boundary (not true in examples above)</p><p><strong>text segment</strong> in low end</p><p><strong>static data segment</strong> (consts and other static variables) above text</p><p>Risc-v convention <strong><code>gp</code> global pointer</strong> points to static</p><p>rv32 gp <code>0x1000_0000</code></p><p><strong>heap</strong> above static for data structures that grow and shrink. Grows up to high addresses.</p><h3 id="frame-pointer-s0"><a class="markdownIt-Anchor" href="#frame-pointer-s0"></a> Frame pointer <code>s0</code></h3><p>As a reminder, we shove all the C local variables etc. on the stack, combined with space for all the saved registers. (This is called the ‘activation record’ or ‘call frame’ or ‘call record’).</p><p>But a naive compiler may cause the stack pointer to bounce up and down during a function call (a lot simpler to have compiler do bunch of pushes and pops when it needs a bit of temp space).</p><p>Plus, not all programming langs can store all activation records on the stack (e.g lambda, call frames allocated on heap since variables can last beyond the function call)</p><p>Therefore, at the start, <strong>save <code>s0</code> and then have the Frame Pointer point to one below the sp when you were called</strong>. Then, <strong>address local variables off the <code>fp</code> rather than the <code>sp</code></strong>.</p><p>simplifies the compiler and debugger.</p><p>Note: it isn’t necessary in C, and since it’s a callee saved reg, it doesn’t matter.</p><p>(因为不call/return函数的时候也可能需要改变stack pointer, 所以整了一个frame pointer指向栈中元素，取代stack pointer.)</p><img src="/2022/29_cs110/use-s0-as-a-frame-pointer.png" srcset="/img/loading.gif" lazyload> <img src="/2022/29_cs110/fp.png" srcset="/img/loading.gif" lazyload><h3 id="instructions"><a class="markdownIt-Anchor" href="#instructions"></a> Instructions</h3><p>6-basic types of instruction formats</p><ul><li><strong>R-format</strong> for reg-reg arithmetic operations</li><li><strong>I-format</strong> for reg-imm arithmetic operations and loads</li><li><strong>S-format</strong> for stores</li><li><strong>B-format</strong> for branches (major variant of S, called <strong>SB</strong> before)</li><li><strong>U-format</strong> for 20-bit upper imm</li><li><strong>J-format</strong> for jumps(minor variant of U, called <strong>UJ</strong> before)</li></ul><img src="/2022/29_cs110/instruction_formats_all.png" srcset="/img/loading.gif" lazyload><h1 id="lecture-7-riscv-multi-float"><a class="markdownIt-Anchor" href="#lecture-7-riscv-multi-float"></a> Lecture 7. Riscv multi &amp; float</h1><h3 id="floating-point-representation"><a class="markdownIt-Anchor" href="#floating-point-representation"></a> Floating point representation</h3><p>SEM / SES / sign, exponent, significand mantissa.</p><p>use <strong>‘biased exponent’</strong> : want float numbers to be used even if no fp hardware (e.g compare float using integer compares). 2’s complement poses a problem</p><p><strong>‘biased notation’</strong>: bias is the number subtracted to get final answer.</p><h3 id="special-numbers"><a class="markdownIt-Anchor" href="#special-numbers"></a> <strong>Special numbers</strong>:</h3><table><thead><tr><th>E</th><th>M</th><th>Object</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>nonzero</td><td>Denorm</td></tr><tr><td>1~254</td><td>anything</td><td>+/- fl. pt.</td></tr><tr><td>255</td><td>0</td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>+</mo><mi mathvariant="normal">/</mi><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">+/- \infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">+</span><span class="mord">/</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord">∞</span></span></span></span></td></tr><tr><td>255</td><td>nonzero</td><td>NaN</td></tr></tbody></table><p>smallest positive normalized number: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mn>126</mn></mrow></msup></mrow><annotation encoding="application/x-tex">2^{-126}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8141079999999999em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">2</span><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></span></p><p>smallest positive denorm: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mn>149</mn></mrow></msup></mrow><annotation encoding="application/x-tex">2^{-149}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8141079999999999em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span><span class="mord mtight">4</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span></p><h1 id="lecture-8-riscv-call"><a class="markdownIt-Anchor" href="#lecture-8-riscv-call"></a> Lecture 8. Riscv call</h1><h3 id="interpretation-vs-translation"><a class="markdownIt-Anchor" href="#interpretation-vs-translation"></a> Interpretation VS Translation</h3><p>Interpretation (e.g. Python): slower, programs smaller</p><p>Translation: compile and then run, faster, architecture-specified</p><h3 id="steps-in-compiling-a-c-program"><a class="markdownIt-Anchor" href="#steps-in-compiling-a-c-program"></a> Steps in compiling a C program</h3><p>CALL: compiler, assembler, linker, loader</p><p>You write <code>.c</code>, compiler produces <code>.s</code>, assembler produces <code>.o</code>, linker produces <code>exec</code>, loader</p><ul><li><strong>Compiler</strong>:<ul><li><strong>lexer</strong> (词法分析, 生成token)</li><li><strong>parser</strong> (produces AST)</li><li><strong>semantic analysis</strong>(进一步分析是否合法)</li><li>optimize</li><li>code generation (can contain pseudo code)</li></ul></li><li><strong>Assembler</strong>:</li><li>read and uses <strong>directives</strong> (doesn’t produce machine code) <code>.data, .text, .word, ......</code>;</li><li><strong>Symbol Table</strong>(list of labels and data that can be referenced across files),</li><li><strong>Relocation Table</strong> (what address does linker need to handle? contains any external label jumped to and data in static section (la))</li><li><strong>Linker</strong>: put data segment together, text segment together, resolve references</li></ul><h3 id="static-vs-dynamically-linked-libraries"><a class="markdownIt-Anchor" href="#static-vs-dynamically-linked-libraries"></a> Static vs Dynamically linked libraries</h3><p>dynamically linked libraries: link at runtime</p><h1 id="lecture-9-synchronous-digital-systems"><a class="markdownIt-Anchor" href="#lecture-9-synchronous-digital-systems"></a> Lecture 9. Synchronous Digital Systems</h1><p><strong>CMOS</strong> (complementary metal-oxide on Semiconductor 互补金属氧化物半导体)</p><img src="/2022/29_cs110/CMOS-NPchannel.png" srcset="/img/loading.gif" lazyload><p>CMOS circuit rules: Don’t pass weak values! Use N-type transistors only to pass zero, P only 1.</p><h4 id="laws-of-boolean-algebra"><a class="markdownIt-Anchor" href="#laws-of-boolean-algebra"></a> Laws of Boolean algebra</h4><img src="/2022/29_cs110/law-of-boolean-algebra.png" srcset="/img/loading.gif" lazyload><p>Note the last one ： <strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><mi>X</mi><mi>Y</mi></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mi>X</mi><mo stretchy="true">‾</mo></mover><mo>+</mo><mover accent="true"><mi>Y</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{XY} = \overline{X} + \overline{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8833300000000001em;vertical-align:0"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8833300000000001em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07847em">X</span><span class="mord mathnormal" style="margin-right:.22222em">Y</span></span></span><span style="top:-3.80333em"><span class="pstrut" style="height:3em"></span><span class="overline-line" style="border-bottom-width:.04em"></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.9666600000000001em;vertical-align:-.08333em"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8833300000000001em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07847em">X</span></span></span><span style="top:-3.80333em"><span class="pstrut" style="height:3em"></span><span class="overline-line" style="border-bottom-width:.04em"></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.8833300000000001em;vertical-align:0"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8833300000000001em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.22222em">Y</span></span></span><span style="top:-3.80333em"><span class="pstrut" style="height:3em"></span><span class="overline-line" style="border-bottom-width:.04em"></span></span></span></span></span></span></span></span></span></strong> !!!</p><h4 id="type-of-circuits"><a class="markdownIt-Anchor" href="#type-of-circuits"></a> Type of circuits</h4><p>SDS consist of 2 basic types of circuits: <strong>CL</strong> (combinational logic) and <strong>SL</strong>(sequential logic)</p><h4 id="flip-flop-timing"><a class="markdownIt-Anchor" href="#flip-flop-timing"></a> Flip-flop timing</h4><p>(Edge-triggered d-type flip flop)</p><img src="/2022/29_cs110/flip-flop-timing-register.png" srcset="/img/loading.gif" lazyload><h4 id="time-constraint-for-sds"><a class="markdownIt-Anchor" href="#time-constraint-for-sds"></a> Time constraint for SDS</h4><ul><li><strong>Max hold time</strong> = min CL delay + clk-to-q delay (hold time 不能长于它的input会发生改变的时间，否则不能保持stable)</li><li><strong>Min clock period</strong> = max CL delay + clk-to-q delay + setup time （clock需要留一段时间让input发生变化，再留一段时间让input保持stable）</li></ul><h1 id="lecture-11-datapath"><a class="markdownIt-Anchor" href="#lecture-11-datapath"></a> Lecture 11. Datapath</h1><h3 id="five-stages"><a class="markdownIt-Anchor" href="#five-stages"></a> Five stages</h3><ul><li><strong>IF</strong> / instruction fetch</li><li><strong>ID</strong> / Instruction decode: decode, start reading reg, imm</li><li><strong>EX</strong> / execute, alu</li><li><strong>MEM</strong> / memory access</li><li><strong>WB</strong> / Register write</li></ul><img src="/2022/29_cs110/single-cycle-cpu-datapath.png" srcset="/img/loading.gif" lazyload> <img src="/2022/29_cs110/control-logic-truth-table.png" srcset="/img/loading.gif" lazyload><h1 id="lecture-13-pipelining"><a class="markdownIt-Anchor" href="#lecture-13-pipelining"></a> Lecture 13. Pipelining</h1><p><strong>Pipelining</strong>: <strong>higher throughput</strong> at the cost of higher latency</p><h3 id="pipelined-risc-v-datapath"><a class="markdownIt-Anchor" href="#pipelined-risc-v-datapath"></a> Pipelined Risc-v datapath</h3><p>每个stage中间添加寄存器</p><img src="/2022/29_cs110/Pipelined-datapath.png" srcset="/img/loading.gif" lazyload><h3 id="hazards"><a class="markdownIt-Anchor" href="#hazards"></a> Hazards</h3><h4 id="1-structural-hazard"><a class="markdownIt-Anchor" href="#1-structural-hazard"></a> 1. Structural hazard</h4><p>Conflict use of a resource.</p><p>分为寄存器和内存。寄存器的解决方法是一次可以读两个写一个，内存的解决方法是把IMEM DMEM用cache分开。</p><ul><li><p><strong>Regfile structural hazards</strong>: each inst can read 2 reg, write 1 reg, so avoid it by having separate ‘ports’ (read two, write one simultaneously)</p></li><li><p><strong>Memory</strong>: Imem and Dmem used simutaneously. Solve by caches (2 separate memories). (Without, inst fetch would have to stall)</p></li></ul><p>risc ISA designed to avoid structural hazards (e.g. 1 mem access per inst)</p><h4 id="2-data-hazard"><a class="markdownIt-Anchor" href="#2-data-hazard"></a> 2. Data hazard</h4><p>分为寄存器和ALU和load delay slot。</p><p>寄存器的解决方法是，一个周期先读再写。</p><p>ALU的解决方法是forwarding。</p><p>load delay slot没办法解决，必须stall一个周期。可以通过reorder code 来缓解。</p><ul><li><strong>Reg access</strong>: Register access policy: first read then write.</li><li><strong>ALU result</strong>:<ul><li>Solution 1: <strong>Stalling</strong>: (compiler can rearange codes or insert NOPs to avoid)</li><li>Solution 2: <strong>Forwarding</strong>: <code>if (instM.rd == instX.rs1) use value of ALU instead of Reg</code>. (Must ignore writes to <code>x0</code>).</li></ul></li></ul><img src="/2022/29_cs110/forwarding.png" srcset="/img/loading.gif" lazyload><p>​ Forwarding datapath</p><img src="/2022/29_cs110/forwarding-datapath.png" srcset="/img/loading.gif" lazyload><ul><li><strong>Load data hazard</strong><ul><li>Slot after a load is called <strong>load delay slot</strong>. If 2nd inst uses result of load, must stall for 1 cycle.</li><li>Solution: put unrelated inst into load delay slot.</li></ul></li></ul><h4 id="3-control-hazard"><a class="markdownIt-Anchor" href="#3-control-hazard"></a> 3. Control hazard</h4><p>分支，必须在alu stage之后才能知道结果。要么顺序执行，不对了赶紧kill，要么加上分支预测。</p><ul><li>Execute sequentially (always predict branch not taken)</li></ul><p>​ Kill instructions after branch if taken (luckily no state is changed at this time)</p><img src="/2022/29_cs110/control-hazard-simple.png" srcset="/img/loading.gif" lazyload><ul><li><strong>Branch prediction</strong>:<ul><li>In IM stage, predict and calculate PC (giving to next clock cycle)</li></ul></li></ul><h1 id="lecture-14-superscalar-cpus"><a class="markdownIt-Anchor" href="#lecture-14-superscalar-cpus"></a> Lecture 14. Superscalar CPUs</h1><blockquote><p>Greater <strong>Instruction-Level Parallelism (ILP)</strong></p><ul><li>Multiple issue ‘superscalar’<ul><li>Replicate pipeline stages =&gt; Multiple pipelines</li><li>Start multiple instructions per clock cycle</li></ul></li><li>“Out-of-Order” execution</li><li>Hyper-threading</li></ul></blockquote><h2 id="ilp-instruction-level-parallelism"><a class="markdownIt-Anchor" href="#ilp-instruction-level-parallelism"></a> ILP (Instruction-level parallelism)</h2><h3 id="hyper-threading-超线程"><a class="markdownIt-Anchor" href="#hyper-threading-超线程"></a> Hyper-threading 超线程</h3><ul><li>Duplicate state-holding elements (PC和寄存器), same CL (mem和ALU仍然只有一个)</li><li>Use <strong>mux</strong> to select which state to use for every clock cycle</li><li>Run 2 independent processes</li><li>No obvious speedup, still one cycle one instruction.</li></ul><h3 id="superscalar"><a class="markdownIt-Anchor" href="#superscalar"></a> Superscalar</h3><ul><li><p>In-order issue, out-of-order execute (多个functional units，如ALU和FPU等), in-order commit</p></li><li><p><strong>More than 1 instruction per clock cycle</strong></p></li><li><p><strong>NOT Multicore</strong>: computing inst from the same program, not different thread! 不是多核，cpu在执行同一个程序！</p></li><li><p>SISD (single inst stream, single data stream). However most superscalar processors are also SIMD.</p></li></ul><h3 id="iron-law-remember-this"><a class="markdownIt-Anchor" href="#iron-law-remember-this"></a> Iron-Law (REMEMBER THIS!!!)</h3><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>r</mi><mi>o</mi><mi>g</mi><mi>r</mi><mi>a</mi><mi>m</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>I</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mi>P</mi><mi>r</mi><mi>o</mi><mi>g</mi><mi>r</mi><mi>a</mi><mi>m</mi></mrow></mfrac><mo>×</mo><mi>C</mi><mi>P</mi><mi>I</mi><mo>×</mo><mfrac><mrow><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi></mrow><mrow><mi>C</mi><mi>y</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{Time}{Program} = \frac{Instruction}{Program} \times CPI \times \frac{Time}{Cycle}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.2407700000000004em;vertical-align:-.8804400000000001em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">P</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.2407700000000004em;vertical-align:-.8804400000000001em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">P</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.76666em;vertical-align:-.08333em"></span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal" style="margin-right:.13889em">P</span><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:2.2407700000000004em;vertical-align:-.8804400000000001em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">e</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>Time the program needs = how many instructions executed * cycles per inst * time per cycle.</p><h4 id="计算cpi"><a class="markdownIt-Anchor" href="#计算cpi"></a> 计算CPI</h4><ul><li>法1</li></ul><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mi>P</mi><mi>I</mi><mo>=</mo><mfrac><mrow><mi>C</mi><mi>y</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow><mrow><mi>I</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi></mrow><mrow><mi>P</mi><mi>r</mi><mi>o</mi><mi>g</mi><mi>r</mi><mi>a</mi><mi>m</mi></mrow></mfrac><mo>÷</mo><mo stretchy="false">(</mo><mfrac><mrow><mi>I</mi><mi>n</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>u</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><mrow><mi>P</mi><mi>r</mi><mi>o</mi><mi>g</mi><mi>r</mi><mi>a</mi><mi>m</mi></mrow></mfrac><mo>×</mo><mfrac><mrow><mi>T</mi><mi>i</mi><mi>m</mi><mi>e</mi></mrow><mrow><mi>C</mi><mi>y</mi><mi>c</mi><mi>l</mi><mi>e</mi></mrow></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">CPI = \frac{Cycle}{Instruction} = \frac{Time}{Program} \div (\frac{Instruction}{Program} \times \frac{Time}{Cycle})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal" style="margin-right:.13889em">P</span><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.0574399999999997em;vertical-align:-.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.2407700000000004em;vertical-align:-.8804400000000001em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">P</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">÷</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:2.2407700000000004em;vertical-align:-.8804400000000001em"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">P</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:2.2407700000000004em;vertical-align:-.8804400000000001em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">e</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">T</span><span class="mord mathnormal">i</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.8804400000000001em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></p><ul><li><p>法2</p><p>First calculate the CPI for each individual inst (add, etc).</p><p>Then calculate the frequency of each individual inst.</p><p>Finally multiply them together for each inst and sum (the weighted sum).</p></li></ul><h3 id="complex-pipeline"><a class="markdownIt-Anchor" href="#complex-pipeline"></a> Complex pipeline</h3><ul><li>More than 1 Functional Unit</li><li>浮点<ul><li>Fadd &amp; Fmul：fixed number of cycles &gt; 1; Fdiv: unknown number of cycles</li></ul></li><li>Issue: assign instruction to functional unit.</li></ul><h4 id="modern-complex-in-order-pipeline"><a class="markdownIt-Anchor" href="#modern-complex-in-order-pipeline"></a> Modern complex in-order pipeline</h4><img src="/2022/29_cs110/Modern-complex-inorder-pipeline.png" srcset="/img/loading.gif" lazyload><h3 id="static-multiple-issue-aka-vliw-very-long-instruction-word"><a class="markdownIt-Anchor" href="#static-multiple-issue-aka-vliw-very-long-instruction-word"></a> Static Multiple issue (aka VLIW (very long instruction word) )</h3><p>一次取出两条指令，如果一条整数/mem，一条浮点，就同时issue。</p><p>现代的CPU，4-issue再往上成本就很大了。</p><p>Adds more complexity to compiler.</p><h3 id="a-question"><a class="markdownIt-Anchor" href="#a-question"></a> A question.</h3><p>hyperthreading CANNOT execute more than 1 process/thread at a given time</p><p>superscalar CANNOT execute more than 1 process/thread at a given time</p><p>multi-core CAN execute more than 1 process/thread at a given time</p><h3 id="dynamic-multiple-issues-superscalar"><a class="markdownIt-Anchor" href="#dynamic-multiple-issues-superscalar"></a> Dynamic Multiple Issues (superscalar)</h3><p>乱序执行（in-order issue, out-of-order execute, in-order commit）</p><p>ROB（Re-order buffer）</p><p>Hardware guarantees correctness. Has nothing to do with compiler.</p><h1 id="lecture-16-cache-i"><a class="markdownIt-Anchor" href="#lecture-16-cache-i"></a> Lecture 16. Cache I</h1><h3 id="locality-局部性原理"><a class="markdownIt-Anchor" href="#locality-局部性原理"></a> Locality 局部性原理</h3><ul><li>Temporal Locality</li><li>Spatial Locality</li></ul><h3 id="caches"><a class="markdownIt-Anchor" href="#caches"></a> Caches</h3><h4 id="fully-associative"><a class="markdownIt-Anchor" href="#fully-associative"></a> Fully-associative</h4><ul><li>No set index. n cache lines, 1 set.</li><li>1 comparator per line.</li></ul><h4 id="direct-mapped"><a class="markdownIt-Anchor" href="#direct-mapped"></a> Direct mapped</h4><ul><li><p>n cache lines, n sets.</p></li><li><p>Only 1 comparator</p></li></ul><h4 id="n-way-set-associative"><a class="markdownIt-Anchor" href="#n-way-set-associative"></a> N-way Set-associative</h4><ul><li><p>N places for a line.</p></li><li><p>N comparators.</p></li><li><p><strong>T/I/O: Tag / Set Index / Block offset</strong></p></li><li><p>number of sets = number of lines / N</p></li><li><p>size of index = log2 (number of sets)</p></li><li><p>size of tag = address size - size of index - log2(number of bytes per block)</p></li><li><p><strong>全相联和直接映射是组相联的特例</strong>：Fully associative: N = number of lines; Direct mapped: N = 1</p></li></ul><p><strong>associativity</strong> 就是 <strong>number of ways</strong>; cache line, cache block 是一个意思</p><p>**C = N * S * B: ** Total cache capacity = associativity * number of sets * block size (bytes per block)</p><h1 id="lecture-17-cache-ii"><a class="markdownIt-Anchor" href="#lecture-17-cache-ii"></a> Lecture 17. Cache II</h1><h3 id="writing-写操作"><a class="markdownIt-Anchor" href="#writing-写操作"></a> Writing 写操作</h3><h4 id="write-through-policy"><a class="markdownIt-Anchor" href="#write-through-policy"></a> Write-through policy</h4><ul><li>同时写给cache和memory</li><li>一般会搞一个write buffer，保证内存速度跟不上时CPU不停止，加快写速度</li><li>优点：更简单的控制逻辑；冗余两份数据，更安全 (Big idea: Redundancy)</li></ul><h4 id="write-back-policy"><a class="markdownIt-Anchor" href="#write-back-policy"></a> Write-back policy</h4><ul><li>只写给cache，每条cache line有dirty bit，只有cache满了才会evict并写入memory</li><li>优点：reduce write traffic，通常性能更高</li></ul><h4 id="write-allocate"><a class="markdownIt-Anchor" href="#write-allocate"></a> Write-allocate</h4><ul><li>If writing to memory not in the cache, fetch it to the cache line first.</li></ul><h4 id="no-write-allocate"><a class="markdownIt-Anchor" href="#no-write-allocate"></a> No-write allocate</h4><ul><li>Just write to memory without a fetch</li></ul><h3 id="cache-replacement-policies"><a class="markdownIt-Anchor" href="#cache-replacement-policies"></a> Cache replacement policies</h3><p>TODO!!!</p><h4 id="random"><a class="markdownIt-Anchor" href="#random"></a> Random</h4><h4 id="lru-least-recently-used"><a class="markdownIt-Anchor" href="#lru-least-recently-used"></a> LRU (Least-Recently used)</h4><ul><li><p>LRU cache state must be updated on every access</p></li><li><p>replace the entry that has not been used for the longest time</p></li><li><p>for 2-way cache, need 1 bit for LRU replacement</p></li></ul><h4 id="pseudo-lru"><a class="markdownIt-Anchor" href="#pseudo-lru"></a> Pseudo LRU</h4><ul><li>hardware replacement pointer points to one cache entry 指向可被替换的entry</li><li>whenever access the entry the ptr points to, move to next; otherwise, don’t move ptr</li><li>not-most-recently-used</li></ul><h3 id="amat-average-memory-access-time-平均访存时间"><a class="markdownIt-Anchor" href="#amat-average-memory-access-time-平均访存时间"></a> AMAT (Average memory access time) 平均访存时间</h3><ul><li><strong>Miss Penalty</strong>: time to replace a cache line from lower level in memory hierarchy to cache (包括写回内存 write back的时间)</li><li><strong>Hit time</strong>: time to access cache memory (包括tag comparision的时间)</li></ul><p>AMAT = time for a hit + miss rate * miss penalty</p><h3 id="ping-pong-effect-in-direct-mapped-cache"><a class="markdownIt-Anchor" href="#ping-pong-effect-in-direct-mapped-cache"></a> Ping-pong effect (in direct mapped cache)</h3><ul><li><p>0 4 0 4 0 4 0 4 互相踢掉对方的例子</p></li><li><p>Set-associative can solve it</p></li></ul><p>For a fixed-size cache and fixed block size, associativity increase by 2 ==&gt; number of blocks per set *2, number of sets ÷ 2</p><h3 id="3c"><a class="markdownIt-Anchor" href="#3c"></a> 3C</h3><h4 id="compulsory-miss"><a class="markdownIt-Anchor" href="#compulsory-miss"></a> Compulsory miss</h4><ul><li>cold start</li><li>solution: increase block size (but increases miss penalty; too large blocks affect miss rate)</li><li>calculation: set cache size to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord">∞</span></span></span></span> and fully associative, count # of misses</li></ul><h4 id="capacity-miss"><a class="markdownIt-Anchor" href="#capacity-miss"></a> Capacity miss</h4><ul><li>Solution: increase cache size (may increase access time)</li><li>calculation: change cache size from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord">∞</span></span></span></span>, usually in powers of 2, and count misses for each reduction in size</li></ul><h4 id="conflict-miss"><a class="markdownIt-Anchor" href="#conflict-miss"></a> Conflict miss</h4><ul><li><p>multiple mem locations mapped to the same cache location</p></li><li><p>solution 1: increase cache size</p></li><li><p>solution 2: increase associativity (may increase access time)</p></li><li><p>calculation: change from fully associative to n-way set associative while counting misses</p></li><li><p>Suppose you went through the entire string of accesses with a fully associative cache (with an LRU replacement policy), if it hits, conflict miss, otherwise, capacity miss</p><p>假设把整段内存地址使用LRU的fully associative cache全部访问一遍，如果在这个cache里回来的时候hit了，说明是conflict miss，否则说明是capacity miss</p></li></ul><h1 id="lecture-18-cache-iii"><a class="markdownIt-Anchor" href="#lecture-18-cache-iii"></a> Lecture 18. Cache III</h1><h3 id="victim-cache"><a class="markdownIt-Anchor" href="#victim-cache"></a> Victim cache</h3><p>Have a very small <strong>fully-associative “victim” cache</strong>. When evicting a cache entry, put it in the victim cache.</p><h3 id="local-vs-global-miss-rate"><a class="markdownIt-Anchor" href="#local-vs-global-miss-rate"></a> Local vs Global miss rate</h3><h4 id="local-miss-rate"><a class="markdownIt-Anchor" href="#local-miss-rate"></a> Local miss rate</h4><ul><li>The fraction of references to one level of a cache that miss</li><li><strong>Local miss rate L2 = L2 miss / L1 miss</strong> ( # of L1 misses = # of L2 accesses )</li></ul><h4 id="global-miss-rate"><a class="markdownIt-Anchor" href="#global-miss-rate"></a> Global miss rate</h4><ul><li>The fraction of references that miss in all levels of a multilevel cache</li><li>L2 local miss rate &gt;&gt; global miss rate</li><li><strong>Global miss rate = L2 miss / Total access = L2 local miss rate * L1 local miss rate</strong></li></ul><h4 id="amat"><a class="markdownIt-Anchor" href="#amat"></a> AMAT</h4><ul><li><strong>AMAT = Time for L1 hit + L1 local miss rate * (Time for L2 hit + L2 local miss rate * L2 miss penalty)</strong></li></ul><h1 id="lecture-19-dlp"><a class="markdownIt-Anchor" href="#lecture-19-dlp"></a> Lecture 19. DLP</h1><h3 id="parallelism"><a class="markdownIt-Anchor" href="#parallelism"></a> Parallelism</h3><ul><li>Two basic ways: <strong>Multiprogramming</strong> (多程序并发 运行不同任务); <strong>Parallel computing</strong> (运行同一个任务)</li></ul><h4 id="sisd-single-inst-single-data-stream"><a class="markdownIt-Anchor" href="#sisd-single-inst-single-data-stream"></a> SISD (single inst single data stream)</h4><p>Superscalar is SISD because programming model is sequential (even though it can execute several inst in one time, when you program this, you don’t care)</p><h4 id="simd-aka-hw-level-data-parallelism"><a class="markdownIt-Anchor" href="#simd-aka-hw-level-data-parallelism"></a> SIMD (aka hw-level data parallelism)</h4><p>exploits multiple data streams against a single instruction 多组数据流 同一种操作</p><h4 id="mimd"><a class="markdownIt-Anchor" href="#mimd"></a> MIMD</h4><p>multiple autonomous processors execute different inst on different data</p><h3 id="amdahls-heartbreaking-law"><a class="markdownIt-Anchor" href="#amdahls-heartbreaking-law"></a> Amdahl’s (Heartbreaking) Law</h3><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Speedup</mtext><mo>=</mo><mfrac><mn>1</mn><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>F</mi><mo stretchy="false">)</mo><mo>+</mo><mfrac><mi>F</mi><mi>S</mi></mfrac></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Speedup} = \frac{1}{(1-F) + \frac{F}{S}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord text"><span class="mord">Speedup</span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.428771em;vertical-align:-1.1073309999999998em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.2376690000000004em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="mclose">)</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.872331em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">S</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">F</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1073309999999998em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>Suppose enhancement E accelerates a fraction <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">F &lt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72243em;vertical-align:-.0391em"></span><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span></span></span></span> of the task by a factor <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">S&gt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.72243em;vertical-align:-.0391em"></span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.64444em;vertical-align:0"></span><span class="mord">1</span></span></span></span>, and the remainder of the task is unaffected.</p><h3 id="三个思想"><a class="markdownIt-Anchor" href="#三个思想"></a> 三个思想</h3><h4 id="1-优化瓶颈"><a class="markdownIt-Anchor" href="#1-优化瓶颈"></a> 1. 优化瓶颈</h4><h4 id="2-合理利用计算资源"><a class="markdownIt-Anchor" href="#2-合理利用计算资源"></a> 2. 合理利用计算资源</h4><h4 id="3-对问题拆分观察是否可以归纳进行并行操作"><a class="markdownIt-Anchor" href="#3-对问题拆分观察是否可以归纳进行并行操作"></a> 3. 对问题拆分，观察是否可以归纳，进行并行操作</h4><p>​	不要着急用原来的知识做，交给计算机或特定平台使用时可能不高效，换个思路，可以把大问题拆分（先做乘法再做加法）</p><h1 id="lecture-20-tlp1-openmp"><a class="markdownIt-Anchor" href="#lecture-20-tlp1-openmp"></a> Lecture 20. TLP1 &amp; Openmp</h1><h3 id="threads"><a class="markdownIt-Anchor" href="#threads"></a> Threads</h3><ul><li>Thread: a sequential flow of instructions 线程就是一个指令流</li><li>Each thread has a PC + reg and access the shared memory (每个线程都有逻辑概念的PC、寄存器和内存)</li><li>Each processor provides one (or more) hardware threads 处理器在硬件层面提供了多个线程</li><li>Operating system multiplexes multiple software threads onto the available hardware threads (操作系统把程序分配到硬件层面的线程，实现调度和分发)</li></ul><h4 id="hardware-multi-threading-hyperthreading"><a class="markdownIt-Anchor" href="#hardware-multi-threading-hyperthreading"></a> Hardware multi-threading (hyperthreading)</h4><p>HW switch thread to do other works while waiting for cache miss</p><p>cost of thread context switch must &lt; cache miss latency</p><p>put redundent hardware so don’t have to save context (e.g. PC, registers)</p><h3 id="data-races-and-synchroniztion"><a class="markdownIt-Anchor" href="#data-races-and-synchroniztion"></a> Data Races and Synchroniztion</h3><ul><li>Different threads, same memory location, at least one is write ==&gt; <strong>data race</strong></li><li>Avoid by <strong>synchronizing writing and reading</strong> by <strong>user-level routines that rely on hardware synchronization instructions</strong> 利用硬件支持来手动同步读和写操作</li></ul><h4 id="solution1-read-write-pairs"><a class="markdownIt-Anchor" href="#solution1-read-write-pairs"></a> Solution1. Read / Write pairs</h4><ul><li><p><strong>lr</strong> (load reserved) and <strong>sc</strong> (store conditional)</p></li><li><p><strong><code>lr rd rs</code></strong>: <code>rd = mem[rs]</code>, and add a reservation</p></li><li><p><strong><code>sc rd rs1 rs2</code></strong>: <code>if (reservation valid) &#123; mem[rs1] = rs2; rd = 0; &#125; else &#123;rd = nonzero;&#125;</code></p></li><li><p>Example: swap</p><p>锁 在内存上（shared memory model）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs assembly">        li      t2  1<br>try:<br>        lr      t1  s1 				# t1 = mem[s1]<br>        bne     t1  x0  try 	<br>        sc      t0  s1  t2  	# try mem[s1] = 1<br>        bne     t0  x0  try<br>locked:<br>        # critical section<br>unlock:<br>        sw      x0  0(s1)<br></code></pre></td></tr></table></figure></li></ul><h4 id="solution2-amo"><a class="markdownIt-Anchor" href="#solution2-amo"></a> Solution2. AMO</h4><ul><li><p>Encoded with R-type instruction format (e.g. <strong><code>AMOSWAP</code></strong>)</p></li><li><p><strong><code>AMOSWAP rd rs2 (rs1)</code></strong>: <code>rd = mem[rs1], mem[rs1] = rs2</code></p></li><li><p><code>aq</code>(acquire) and <code>rl</code>(release) to ensure in-order execution</p></li><li><p>Example:</p><img src="/2022/29_cs110/amoswap.png" srcset="/img/loading.gif" lazyload></li></ul><h1 id="lecture-22-os"><a class="markdownIt-Anchor" href="#lecture-22-os"></a> Lecture 22. OS</h1><h3 id="what-does-the-os-do"><a class="markdownIt-Anchor" href="#what-does-the-os-do"></a> What does the OS do?</h3><ul><li><p>loads, runs and manages programs</p><ul><li>Time-sharing (multiple programs at the same time)</li><li>Isolation</li><li>multiples resources between applications (e.g. devices)</li></ul></li><li><p>Services: File system, network, printer…</p></li><li><p>As referee (作为裁判): fair sharing of resources among applications （调度进程，分配资源）</p></li><li><p>As illusionist (作为幻术师): provide application with “infinite” resources （每个程序都认为自己独占CPU，独占一大整块内存）</p></li><li><p>As glue (作为胶水): provide application with standard service interface （与IO设备交互</p></li></ul><h3 id="os-boot-sequence"><a class="markdownIt-Anchor" href="#os-boot-sequence"></a> OS boot sequence</h3><p>BIOS --&gt; Bootloader --&gt; OS boot --&gt; Init</p><p>UEFI (Unified Extensible Firmware Interface), evolution of BIOS</p><h3 id="memory-mapped-io-used-by-risc-v"><a class="markdownIt-Anchor" href="#memory-mapped-io-used-by-risc-v"></a> Memory mapped I/O (used by RISC-V)</h3><p>(x86架构使用特殊指令来处理IO，riscv架构使用内存映射IO)</p><p>Use normal load/store instructions for input and output. I/O device registers there.</p><p>Certain address correspond to registers in I/O devices</p><h1 id="lecture-23-virtual-memory"><a class="markdownIt-Anchor" href="#lecture-23-virtual-memory"></a> Lecture 23 Virtual memory</h1><h2 id="why-do-we-need-virtual-memory"><a class="markdownIt-Anchor" href="#why-do-we-need-virtual-memory"></a> Why do we need virtual memory?</h2><ul><li>Adding disks to memory hierarchy</li><li>Simplifying memory for apps (应用程序认为自己独占了一大片内存)</li><li>Protection between processes</li></ul><p><strong>Virtual address space</strong>; <strong>Physical address space</strong></p><h2 id="simple-base-and-bound-translation"><a class="markdownIt-Anchor" href="#simple-base-and-bound-translation"></a> Simple base and bound translation</h2><h4 id="translation"><a class="markdownIt-Anchor" href="#translation"></a> Translation</h4><p>Every process has a base &amp; bound.</p><p>Physical addr = logical addr + base register, then OS checks bound, then map to physical memory.</p><p>只有CPU处在supervisor mode的时候才能获取base and bound registers，CPU在用户态的时候是不能访问的。</p><h4 id="problem-memory-fragmentation-碎片化"><a class="markdownIt-Anchor" href="#problem-memory-fragmentation-碎片化"></a> Problem: <strong>Memory fragmentation</strong> 碎片化</h4><h2 id="blocks-vs-pages"><a class="markdownIt-Anchor" href="#blocks-vs-pages"></a> Blocks vs Pages</h2><p>In VM, we deal with individual pages, usually 1 Page ~ 4KB</p><ul><li>The Memory has several <strong>Pages</strong></li><li>1 Page has several <strong>Blocks</strong></li><li>1 Block has several <strong>Words</strong></li></ul><h3 id="translation-2"><a class="markdownIt-Anchor" href="#translation-2"></a> <strong>Translation</strong>:</h3><p>Virtual page number --&gt; Physical page number; offset keeps the same.</p><p>Processor-generated addr can be split into <strong>page number</strong> and <strong>offset</strong></p><p><strong>Page table</strong>: contains the physical addr of the base of each page</p><p>Page table makes it possible to store the pages of a program <strong>non-contiguously</strong> (允许不连续存储程序的pages).</p><p>Each user has a page table. Page table contains an entry for each user page.</p><p>Page tables are in main memory. Need on ref to retrieve the page base addr and another access to the data word --&gt; doubles the number of memory references</p><h3 id="linear-simble-page-table"><a class="markdownIt-Anchor" href="#linear-simble-page-table"></a> Linear (simble) page table</h3><h4 id="page-table-entry-pte-contains-一个pte里面有什么"><a class="markdownIt-Anchor" href="#page-table-entry-pte-contains-一个pte里面有什么"></a> Page table entry (PTE) contains (一个PTE里面有什么)</h4><ul><li>1 bit to indicate if page exists</li><li>either <strong>PPN (physical page number, for a memory-resident page)</strong> or <strong>DPN(disk page number)</strong></li><li><strong>status bits</strong> for protection and usage (R/W/exec 可读?可写?可执行?)</li></ul><p>OS sets PT base register(page table的基地址,指向PT开头) whenever active user process changes</p><img src="/2022/29_cs110/linear-page-table.png" srcset="/img/loading.gif" lazyload><p><strong>Page fault</strong>: an inst references a memory page that isn’t in DRAM 发现一块虚拟内存对应的是disk page number，在硬盘上。</p><p>Page fault handler does the following:</p><ul><li>如果virtual page不存在(没分配过), 在内存中分配一块</li><li>如果已经存在(但是在硬盘上), 根据usage选择一块当前在DRAM中的page替换掉</li><li>被替换掉的page写回到硬盘中，VPN-&gt;PPN改成VPN-&gt;invalid/DPN</li><li>现在刚才page fault的地址就有PPN了</li></ul><h3 id="hierarchical-page-table-多级页表"><a class="markdownIt-Anchor" href="#hierarchical-page-table-多级页表"></a> Hierarchical page table 多级页表</h3><p>多级页表可以更高效地利用内存空间</p><p><strong>Address translation and protection</strong>:</p><p>VPN --&gt; protection check &amp; address translation --&gt; PPN</p><h3 id="translation-lookaside-buffers-tlb"><a class="markdownIt-Anchor" href="#translation-lookaside-buffers-tlb"></a> Translation Lookaside Buffers (TLB)</h3><img src="/2022/29_cs110/TLB.png" srcset="/img/loading.gif" lazyload><p>Usually fully associative: each entry maps a large page --&gt; less spacial locality across pages</p><p><strong>TLB Reach</strong>: size of the largest virtual addr space that can be simultaneously mapped by TLB</p><img src="/2022/29_cs110/hierarchical-page-table-walk.png" srcset="/img/loading.gif" lazyload><h1 id="lecture-24-fpga"><a class="markdownIt-Anchor" href="#lecture-24-fpga"></a> Lecture 24 FPGA</h1><h3 id="embedded-system"><a class="markdownIt-Anchor" href="#embedded-system"></a> Embedded System</h3><p>Specifically-functioned; tightly constrained; reactive and real-time; hardware and software coexistance</p><p>**Computer-Aided Design (CAD) ** tool</p><p><strong>ASIC: Application-specific integrated circuits</strong> （专用电路）</p><h3 id="fpga-field-programmable-gate-array"><a class="markdownIt-Anchor" href="#fpga-field-programmable-gate-array"></a> FPGA (Field-programmable gate array)</h3><ul><li><p>Higher performance compared to the conventional CPUs （相比于通用的CPU，性能更高，功耗更低）</p></li><li><p>Higher flexibility compared to ASIC （相比于专用电路，更加灵活，因为可以改）</p></li></ul><h1 id="lecture-25-wsc-map-reduce-and-spark"><a class="markdownIt-Anchor" href="#lecture-25-wsc-map-reduce-and-spark"></a> Lecture 25 WSC, Map reduce and Spark</h1><h2 id="warehouse-scale-computing"><a class="markdownIt-Anchor" href="#warehouse-scale-computing"></a> Warehouse Scale Computing</h2><h3 id="unique-to-wscs"><a class="markdownIt-Anchor" href="#unique-to-wscs"></a> Unique to WSCs</h3><p>Single machine （一个机房里有很多服务器，但对外呈现出的是一台机器）</p><p>Ample parallelism: request-level parallelism &amp; data-level parallelism</p><p>High rate/number of failures</p><p>Cost of equipment purchases &lt;&lt; cost of ownership 相比于设备本身成本，维护成本大很多</p><p><strong>Scalability可扩展性, energy efficiency, high failure rate</strong></p><h3 id="wsc-storage-hierarchy"><a class="markdownIt-Anchor" href="#wsc-storage-hierarchy"></a> WSC storage hierarchy</h3><p>Lower latency to DRAM in another server than local disk.</p><p>Higher bandwidth to local disk than to DRAM in another server</p><h2 id="request-level-parallelism-rlp"><a class="markdownIt-Anchor" href="#request-level-parallelism-rlp"></a> Request-level Parallelism (RLP)</h2><p>Implementation startegy: randomly distribute the entries; many copies of data; load balance</p><ul><li><p>High request volume, each largely independent of other</p></li><li><p>use <strong>replication (redundant copies)</strong>: increases opportunities for request-level parallelism; makes the system more tolerant of failures</p></li></ul><h2 id="data-level-parallelism-dlp"><a class="markdownIt-Anchor" href="#data-level-parallelism-dlp"></a> Data-level Parallelism (DLP)</h2><p>SIMD &amp; DLP on WSC (<strong>MapReduce &amp; scalable file systems</strong>)</p><h3 id="mapreduce"><a class="markdownIt-Anchor" href="#mapreduce"></a> MapReduce</h3><ul><li>Map: divide large data set into pieces for independent parallel processing</li><li>Reduce: combine and process intermediate results to obtain final result</li></ul><h1 id="lecture-26-io-dma-disks-networking"><a class="markdownIt-Anchor" href="#lecture-26-io-dma-disks-networking"></a> Lecture 26. I/O DMA Disks Networking</h1><h2 id="review-io"><a class="markdownIt-Anchor" href="#review-io"></a> Review: I/O</h2><ul><li><strong>Memory mapped IO</strong>: device control / data registers mapped to CPU addr space</li><li>CPU synchronize with IO device (polling; interrupts)<ul><li><strong>Polling</strong>: lower latency</li><li><strong>Interrupt</strong>: higher latency, larger throughput (更适合high volume data transfer)</li></ul></li><li><strong>Programmed IO (PIO)</strong> ==&gt; <strong>Direct Memory Access (DMA)</strong></li></ul><h2 id="dma"><a class="markdownIt-Anchor" href="#dma"></a> DMA</h2><p>Allow IO devices to directly r/w main memory.</p><p>New hardware: <strong>DMA engine</strong></p><ul><li>CPU initiate transfer, instructs DMA engine that data is available at certain address</li><li>DMA engine handle the transfer (CPU is free to execute other things)</li><li>DMA engine interrupt CPU again to signal completion</li></ul><img src="/2022/29_cs110/operation-of-DMA-transfer.png" srcset="/img/loading.gif" lazyload><h3 id="problems"><a class="markdownIt-Anchor" href="#problems"></a> Problems</h3><p>Where in the memory hierarchy do we plug in the DMA engine?</p><ul><li>Between CPU and L1 (in cache)<ul><li>Pro: Free coherency</li><li>Con: 挤占CPU cache的空间</li></ul></li><li>Between Last-level cache and main memory<ul><li>Pro: Don’t mess with caches</li><li>Con: 需要显式维护上下数据一致性</li></ul></li></ul><h3 id="problems-2"><a class="markdownIt-Anchor" href="#problems-2"></a> Problems</h3><p>How do we <strong>arbitrate</strong> between CPU and DMA access to memory?</p><ul><li><p><strong>Burst mode</strong>: DMA优先</p></li><li><p><strong>Cycle Stealing Mode</strong>: 交替传输</p><p>​	DMA transfers a byte, releases control, and then repeats/interleaves processor/DMA engine access</p></li><li><p><strong>Transparent Mode</strong>: CPU优先</p></li></ul><h2 id="disks"><a class="markdownIt-Anchor" href="#disks"></a> Disks</h2><ul><li><p>several platters</p></li><li><p>bits recorded in <strong>tracks(磁道)</strong>, divided into <strong>sectors</strong></p></li><li><p><strong>actuator</strong> moves <strong>head(磁头)</strong> over <strong>track</strong>, wait for sector rotate under head, then read or write</p></li><li><p><strong>Disk access time = seek time + rotation time + transfer time + controller overhead</strong></p><ul><li><strong>seek time</strong>: (number of tracks / 3) * time to move across 1 track</li><li><strong>rotation time</strong>: 1/2 time of a rotation</li></ul></li></ul><h2 id="networks"><a class="markdownIt-Anchor" href="#networks"></a> Networks</h2><p>Nothing</p><h1 id="lecture-27-advanced-cache"><a class="markdownIt-Anchor" href="#lecture-27-advanced-cache"></a> Lecture 27. Advanced Cache</h1><h2 id="cache-inclusion"><a class="markdownIt-Anchor" href="#cache-inclusion"></a> Cache inclusion</h2><ul><li><p><strong>Inclusive</strong>: L1有的东西L2也有（load时同时load到L1和L2，踢出时只踢L1）</p></li><li><p><strong>Exclusive</strong>: （load时只load到L1，踢出时放到L2）</p></li><li><p><strong>Non-inclusive</strong></p></li><li><p>Inclusive cache eases coherence</p><ul><li>高层cache有的东西低层一定也有</li><li>L2 needs to evict a block, must ask L1 cache if it has the block</li></ul></li><li><p>Non-inclusive cache higher performance</p><ul><li>No back invalidation</li><li>Larger capacity</li></ul></li></ul><h1 id="lecture-28-dependability-and-raid"><a class="markdownIt-Anchor" href="#lecture-28-dependability-and-raid"></a> Lecture 28. Dependability and RAID</h1><h2 id="dependability-可靠性"><a class="markdownIt-Anchor" href="#dependability-可靠性"></a> Dependability 可靠性</h2><p>Dependability vs. Redundancy</p><ul><li><p><strong>spatial redundancy</strong>: replicated data or hardware, handle hard and soft(transient) failures （e.g 异地备份）</p></li><li><p><strong>temporal redundancy</strong>: redundancy in time, handle soft(transient) failures (e.g. 丢包，重发)</p></li><li><p>Reliability: <strong>MTTF (Mean Time to Failure) 平均出问题的时间</strong></p></li><li><p>Service interruption: <strong>MTTR (Mean Time to Repair) 出问题后平均需要修复的时间</strong></p></li><li><p><strong>MTBF (Mean Time between Failures)</strong> = MTTF + MTTR</p></li><li><p><strong>Availablity</strong> = MTTF / (MTTF + MTTR) 百分比形式</p></li><li><p><strong>AFR (Annualized Failure Rate)</strong> 平均一年内出问题的比率</p></li></ul><h2 id="ecc-error-detectioncorrection-codes"><a class="markdownIt-Anchor" href="#ecc-error-detectioncorrection-codes"></a> ECC (Error detection/correction codes)</h2><h3 id="parity-奇偶校验"><a class="markdownIt-Anchor" href="#parity-奇偶校验"></a> Parity 奇偶校验</h3><p>加一个奇偶校验位，原来有8个bit就对这8个bit做异或，把异或的结果放到第9位一起传输 to keep parity even</p><p>检查的时候必须是0，如果结果不是0说明出错了</p><p>Min Hamming distance of valid parity codes is 2</p><h3 id="hamming-ecc"><a class="markdownIt-Anchor" href="#hamming-ecc"></a> Hamming ECC</h3><ul><li><p>Single error correction, double error detection 纠正一位错，检测两位错</p></li><li><p>用更多的parity bits来识别一位错</p></li><li><p>让第1,2,4,8,16,…位的数据当做parity bits，其它数据是普通的data bits</p></li><li><p>每个parity bit检查 bits with least significant bit of address = 1的位置的奇偶性 (set parity bits to create even parity for each group)</p></li></ul><img src="/2022/29_cs110/Hamming-code-coverage.png" srcset="/img/loading.gif" lazyload><h3 id="cyclic-redundancy-check"><a class="markdownIt-Anchor" href="#cyclic-redundancy-check"></a> Cyclic redundancy check</h3><p>Nothing.</p><h2 id="raid-redundant-arrays-of-inexpensive-disks"><a class="markdownIt-Anchor" href="#raid-redundant-arrays-of-inexpensive-disks"></a> RAID (Redundant arrays of (inexpensive) disks)</h2><h3 id="raid-0-striping"><a class="markdownIt-Anchor" href="#raid-0-striping"></a> RAID 0: Striping</h3><ul><li>striping, or disk spanning 把数据切片写下去</li><li>不提供 redundancy or fault tolerance</li><li>高性能</li></ul><h3 id="raid-1-disk-mirroring-shadowing"><a class="markdownIt-Anchor" href="#raid-1-disk-mirroring-shadowing"></a> RAID 1: Disk Mirroring / Shadowing</h3><ul><li>镜像复制</li><li>提供很高的reliability，但是占用容量、带宽、性能</li></ul><h3 id="raid-3-parity-disk"><a class="markdownIt-Anchor" href="#raid-3-parity-disk"></a> RAID 3: Parity Disk</h3><ul><li>按bit写数据</li><li>如果一块盘挂了，能根据别的硬盘并结合parity恢复出数据</li><li>仅停留在纸面上</li></ul><h3 id="raid-4-high-io-rate-parity"><a class="markdownIt-Anchor" href="#raid-4-high-io-rate-parity"></a> RAID 4: High I/O Rate Parity</h3><ul><li>把数据按块(block/chunk)写入，并留下一块盘专门写parity</li><li>Works well for small reads, but</li><li>问题：有一块单独的盘做parity，这块盘可能成为性能瓶颈</li></ul><h3 id="raid-5-high-io-rate-interleaved-parity"><a class="markdownIt-Anchor" href="#raid-5-high-io-rate-interleaved-parity"></a> RAID 5: High I/O Rate Interleaved Parity</h3><ul><li>几块盘轮流承担parity的角色，避免一块盘的瓶颈（解决RAID4的问题）</li></ul><h1 id="lecture-29-security"><a class="markdownIt-Anchor" href="#lecture-29-security"></a> Lecture 29. Security</h1><h2 id="heartbleed"><a class="markdownIt-Anchor" href="#heartbleed"></a> Heartbleed</h2><ul><li>Found in TLS heartbeat extension</li><li>happens if the packet’s length is not validated</li><li><strong>implementation flow (not design flow)</strong></li></ul><img src="/2022/29_cs110/heartbleed.png" srcset="/img/loading.gif" lazyload><h2 id="eavesdropping-disk-用硬盘来监听"><a class="markdownIt-Anchor" href="#eavesdropping-disk-用硬盘来监听"></a> Eavesdropping disk 用硬盘来监听</h2><ul><li>Re-flashing a disk’s firmware or maliciously leaving a stealthy backdoor 替换硬盘固件，或者硬盘本身的固件留有后门</li><li><strong>PES</strong> (Position Error Signal): 位置偏移，能收到pes这个信号并重新将磁头移到正确位置，这个信号能被读出来，转换成音频信号</li></ul><h2 id="rowhammer"><a class="markdownIt-Anchor" href="#rowhammer"></a> RowHammer</h2><p>不断读写一个内存row without caching</p><ul><li><strong>Hammered row</strong></li><li><strong>Victim row</strong></li><li>happens because DRAM cells are too close to each other; not electrically isolated (electrical interference)</li></ul><img src="/2022/29_cs110/rowhammer.png" srcset="/img/loading.gif" lazyload><h2 id="side-channel-attacks-侧信道攻击"><a class="markdownIt-Anchor" href="#side-channel-attacks-侧信道攻击"></a> Side-channel attacks 侧信道攻击</h2><p>原理是，对于不同的输入，程序会有不同的行为（运算速度、cache使用情况、功耗等），通过分析程序的行为反推出key</p><ul><li>Timing-based attack: 测量程序运行时间（如解密操作的耗时）获得key</li><li>Access-based attack: 测量cache line的hit和miss情况</li></ul><h2 id="flush-reload"><a class="markdownIt-Anchor" href="#flush-reload"></a> Flush + Reload</h2><p>攻击者flush整条cache line，测量reload的时间获得victim在这段时间内是否访问过cache的情况</p><h2 id="meltdown"><a class="markdownIt-Anchor" href="#meltdown"></a> Meltdown</h2><p>由乱序执行产生，造成了不该有的访存操作，出现“访问痕迹”，通过cache line反推出来</p><h2 id="spectre"><a class="markdownIt-Anchor" href="#spectre"></a> Spectre</h2><p>由推断执行产生（如分支预测）</p><h1 id="lecture-30-summary"><a class="markdownIt-Anchor" href="#lecture-30-summary"></a> Lecture 30. Summary</h1><p>Computer architecture !</p><h1 id="my-cheatsheet"><a class="markdownIt-Anchor" href="#my-cheatsheet"></a> My cheatsheet</h1><div class="note note-info"><p>我自己的手写cheatsheet，点击展开。</p><p>仅供参考，可能不全。</p></div><details><h2 id="page-1"><a class="markdownIt-Anchor" href="#page-1"></a> Page 1</h2><img src="/2022/29_cs110/BillsCheatsheet1.jpg" srcset="/img/loading.gif" lazyload><h2 id="page-2"><a class="markdownIt-Anchor" href="#page-2"></a> Page 2</h2><img src="/2022/29_cs110/BillsCheatsheet2.jpg" srcset="/img/loading.gif" lazyload><h2 id="page-3"><a class="markdownIt-Anchor" href="#page-3"></a> Page 3</h2><img src="/2022/29_cs110/BillsCheatsheet3.jpg" srcset="/img/loading.gif" lazyload><h2 id="page-4"><a class="markdownIt-Anchor" href="#page-4"></a> Page 4</h2><img src="/2022/29_cs110/BillsCheatsheet4.jpg" srcset="/img/loading.gif" lazyload></details></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Lecture-Notes/" class="category-chain-item">Lecture Notes</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/C/" class="print-no-link">#C</a> <a href="/tags/Lecture-Notes/" class="print-no-link">#Lecture Notes</a> <a href="/tags/C/" class="print-no-link">#C++</a></div></div><div class="license-box my-3"><div class="license-title"><div>[Lecture Notes] ShanghaiTech CS110 Computer architecture I</div><div>https://www.billhu.us/2022/29_cs110/</div></div><div class="license-meta"><div class="license-meta-item"><div>Author</div><div>Bill Hu</div></div><div class="license-meta-item license-meta-date"><div>Posted on</div><div>June 22, 2022</div></div><div class="license-meta-item"><div>Licensed under</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - Attribution"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/31_pixel3/" title="How to install Android 12 on Google Pixel 3"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">How to install Android 12 on Google Pixel 3</span> <span class="visible-mobile">Previous</span></a></article><article class="post-next col-6"><a href="/2022/28_homeassistant/" title="HomeAssistant on Raspberry Pi"><span class="hidden-mobile">HomeAssistant on Raspberry Pi</span> <span class="visible-mobile">Next</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>Table of Contents</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">Search</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">Keyword</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <span>With </span><a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <a href="/about" target="_blank" rel="nofollow noopener"><span>Bill Hu</span></a><div style="font-size:.85rem"><span id="timeDate">Loading days...</span> <span id="times">Loading time...</span><script src="/js/duration.min.js"></script></div></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing,t=t.getElementById("subtitle");t&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">Blog works best with JavaScript enabled</div></noscript></body></html>